<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.8" />
<title></title>
<style type="text/css">
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .mathblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #003b6b; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #00579e; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #333333; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: Arial, sans-serif; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Arial, sans-serif; font-weight: normal; font-style: normal; color: #7b2d00; text-rendering: optimizeLegibility; margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #ff6b15; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: #003426; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; list-style-position: outside; font-family: Arial, sans-serif; }

ul, ol { margin-left: 1.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3em; font-weight: bold; }
dl dd { margin-bottom: 0.75em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: black; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #e15200; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #e15200; }

blockquote, blockquote p { line-height: 1.6; color: #333333; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
  h4 { font-size: 1.4375em; } }
/* Print styles.  Inlined to avoid required HTTP connection: www.phpied.com/delay-loading-your-print-css/ Credit to Paul Irish and HTML5 Boilerplate (html5boilerplate.com)
*/
.print-only { display: none !important; }

@media print { * { background: transparent !important; color: #000 !important; /* Black prints faster: h5bp.com/s */ box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; /* h5bp.com/t */ }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #d8d8ce; }
/* Change -webkit-linear-gradient colors to  #a70000 and remove gradient */
table thead, table tfoot { background: -webkit-linear-gradient(top, #a70000, #a70000); font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: white; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #6d6e71; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #edf2f2; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; padding: 3px 2px 1px 2px; white-space: nowrap; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; text-shadow: none; }

pre, pre > code { line-height: 1.6; color: black; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

kbd.keyseq { color: #333333; }

kbd:not(.keyseq) { display: inline-block; color: black; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

kbd kbd:first-child { margin-left: 0; }

kbd kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: black; }

b.button:before { content: '[ '; }

b.button:after { content: ' ]'; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 1.5em; padding-right: 1.5em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#header { margin-bottom: 2.5em; }
#header > h1 { color: #7b2d00; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #333333; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }

#toc { border-bottom: 1px solid #dddddd; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }

#toctitle { color: #003b6b; }

@media only screen and (min-width: 768px) { body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: .90em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; border-width: 0; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }

#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }

#footer { max-width: 100%; background-color: none; padding: 1.25em; }

#footer-text { color: black; line-height: 1.44; }

.sect1 { padding-bottom: 1.25em; }

.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #7b2d00; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #622400; }

.imageblock, .literalblock, .listingblock, .mathblock, .verseblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .mathblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }

.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #333333; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }

.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #aaaaaa; box-shadow: 0 1px 8px #aaaaaa; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #003b6b; margin-top: 0; line-height: 1.6; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre:not([class]), .listingblock pre:not([class]) { background: #eeeeee; }
.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border-width: 1px; border-style: dashed; border-color: #666666; -webkit-border-radius: 0; border-radius: 0; padding: 1.25em 1.5625em 1.125em 1.5625em; word-wrap: break-word; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock pre > code, .literalblock pre[class] > code, .listingblock pre > code, .listingblock pre[class] > code { display: block; }
@media only screen { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.72em; } }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.81em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.9em; } }

.listingblock pre.highlight { padding: 0; }
.listingblock pre.highlight > code { padding: 1.25em 1.5625em 1.125em 1.5625em; }

.listingblock > .content { position: relative; }

.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }

.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.sass:before { content: "sass"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }

table.pyhltable { border: 0; margin-bottom: 0; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }

.quoteblock { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 0.75em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: 0.8125em; color: #e15200; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }

table thead th, table tfoot th { font-weight: bold; }

table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 0; border-radius: 0; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }

table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }

table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }

table.tableblock td .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }

th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }

th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }

th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }

th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }

th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }

tbody tr th { display: table-cell; line-height: 1.4; background: -webkit-linear-gradient(top, #add386, #90b66a); }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: white; font-weight: bold; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.375em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.375em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .8em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.qanda > ol > li > p > em:only-child { color: #004985; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }

.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #00579e; color: #004176; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum { display: inline-block; color: white !important; background-color: black; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { border-bottom: 1px solid #dddddd; }

#toctitle { color: #00406F; font-weight: normal; margin-top: 1.5em; }

.sidebarblock { border-color: #aaa; }

code { -webkit-border-radius: 4px; border-radius: 4px; }

p.tableblock.header { color: #6d6e71; }


@media screen {
  body {
    max-width: 80em; /* 50em is approximately 80 characters wide */
    margin-left: 20em; /* this is 3em beyound the width of the toc */
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 20em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
    font-size: 0.9em;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    padding-left: 1.25em;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_circuit_breaker_lab">Circuit Breaker Lab</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this lab, you add circuit breakers around calls to external services in the microservice applications that make up the Coolstore application.</p></div>
<div class="paragraph"><div class="title">Goal</div><p>Enhance the code and configuration of the applications to add the circuit breakers</p></div>
<div class="ulist"><div class="title">Prerequisites</div><ul>
<li>
<p>
Completion of all of the previous labs
</p>
</li>
<li>
<p>
Successful implementation and deployment of the catalog service, inventory service, cart service, and gateway microservice applications
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The labs in this module use the original application code as starting point, without the modifications added by the previous labs.<br />
Before starting the lab, make fresh clones of the lab source code material and redeploy the different microservice applications using the Fabric8 Maven plugin. Alternatively, create separate branches in the lab source code for the different labs.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_circuit_breaker_in_catalog_service_vert_x_application">1. Add Circuit Breaker in Catalog Service Vert.x Application</h2>
<div class="sectionbody">
<div class="paragraph"><p>Vert.x comes with its own implementation of the Circuit Breaker pattern. You can also use Hystrix on Vert.x, but because the Hystrix threading and programming model is different from Vert.x, the integration is more difficult.</p></div>
<div class="paragraph"><p>The catalog service uses a database, so the calls to the database are good candidates to wrap in a circuit breaker.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the POM file of the catalog service project, add the <code>io.vertx:vertx-circuit-breaker</code> dependency.
</p>
</li>
<li>
<p>
In the <code>ApiVerticle</code> class in the <code>com.redhat.coolstore.catalog.api</code> package, add a private field for the <code>CircuitBreaker</code> instance.
</p>
</li>
<li>
<p>
Create the <code>CircuitBreaker</code> instance in the <code>start</code> method, before creating the HTTP server:
</p>
<div class="listingblock">
<div class="content">
<pre><code>circuitBreaker = CircuitBreaker.create("product-circuit-breaker", vertx,
                new CircuitBreakerOptions()
                    .setMaxFailures(3) // number of failure before opening the circuit
                    .setTimeout(1000) // consider a failure if the operation does not succeed in time
                    .setFallbackOnFailure(true) // do we call the fallback on failure
                    .setResetTimeout(5000) // time spent in open state before attempting to re-try
                );</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
You pass a <code>CircuitBreakerOptions</code> instance to the <code>create</code> method to configure the circuit breaker.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Wrap the code in the <code>getProduct</code> method in the circuit breaker.
</p>
<div class="ulist"><ul>
<li>
<p>
The circuit breaker execution has the following format:
</p>
<div class="listingblock">
<div class="content">
<pre><code>execute(future -&gt; {
  // some code executing with the breaker
  // the code reports failures or success on the given future.
  // if this future is marked as failed, the breaker increased the
  // number of failures
}).setHandler(ar -&gt; {
  // get the operation result
})</code></pre>
</div></div>
</li>
<li>
<p>
Wrap the call to the <code>CatalogService</code> in the execute method.
</p>
</li>
<li>
<p>
If the call succeeds, complete the future with the <code>JsonObject</code> result (or with <code>null</code> if the call returned no result), or if the call failed, fail the future.
</p>
</li>
<li>
<p>
If the future succeeds, set the result on the <code>RoutingContext</code> in the handler.
</p>
</li>
<li>
<p>
If the future succeeds but with a <code>null</code> result, fail the <code>RoutingContext</code> with a 404 HTTP status code.
</p>
</li>
<li>
<p>
If the future fails, fail the <code>RoutingContext</code> with a 503 HTTP status code.
</p>
</li>
<li>
<p>
You do not provide a fallback method. Whenever the wrapped code fails or the circuit is opened, the catalog service responds with a 503 HTTP status code, marking the service as unavailable.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Do the same with the <code>getProducts</code> method.
</p>
</li>
<li>
<p>
Execute the tests.
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ cd ~/lab/catalog-service

$ mvn clean test</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Expect all of the tests to pass.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Optionally, write tests to verify that the circuit breaker executes as expected.
</p>
<div class="ulist"><ul>
<li>
<p>
For example, you can verify that a REST call to get the products returns a 503 HTTP status code when <code>CatalogService</code> fails or times out.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Change to the coolstore project
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ export COOLSTORE_PRJ=${OCP_USER_ID}-coolstore

$ oc project $COOLSTORE_PRJ</code></pre>
</div></div>
</li>
<li>
<p>
Deploy the Coolstore catalog service application on OpenShift using the Fabric8 Maven plug-in:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ mvn clean fabric8:deploy -Popenshift -Dfabric8.namespace=$COOLSTORE_PRJ</code></pre>
</div></div>
</li>
<li>
<p>
Test the Coolstore catalog service.
</p>
<div class="ulist"><ul>
<li>
<p>
Retrieve the URL of the Coolstore catalog service application:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ export CATALOG_URL=http://$(oc get route catalog-service -n $COOLSTORE_PRJ -o template --template='{{.spec.host}}')</code></pre>
</div></div>
</li>
<li>
<p>
Retrieve an individual product from the catalog:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ curl -X GET "$CATALOG_URL/product/444435"</code></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Test the circuit breaker is working as expected by scaling down the Catalog MongoDB pods to zero.
</p>
<div class="ulist"><ul>
<li>
<p>
Scale down the pod
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc scale --replicas=0 dc/catalog-mongodb</code></pre>
</div></div>
</li>
<li>
<p>
Attempt to retrieve an individual product from the catalog:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ curl -X GET "$CATALOG_URL/product/444435"</code></pre>
</div></div>
</li>
<li>
<p>
Expect to see: <code>Service Unavailable</code>
</p>
</li>
<li>
<p>
Repeat the curl command. You will notice the slight delay for first three attempts. Then you will get a faster failure response. At this point the circuit breaker is closed and it is no longer calling the affected code. This is based on the configs in the code.
</p>
<div class="listingblock">
<div class="content">
<pre><code>        circuitBreaker = CircuitBreaker.create("product-circuit-breaker", vertx,
                new CircuitBreakerOptions()
                    .setMaxFailures(3) // number of failure before opening the circuit
                    .setTimeout(1000) // consider a failure if the operation does not succeed in time
                    .setFallbackOnFailure(true) // do we call the fallback on failure
                    .setResetTimeout(5000) // time spent in open state before attempting to re-try
                );</code></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Scale up the MongoDB pod.
</p>
<div class="listingblock">
<div class="content">
<pre><code>oc scale --replicas=1 dc/catalog-mongodb</code></pre>
</div></div>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Wait until the catalog-mongodb pod is back up and running.</td>
</tr></table>
</div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Run the <code>curl</code> command again to confirm the catalog-service works as expected.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect1">
<h2 id="_add_circuit_breaker_in_inventory_service_wildfly_swarm_application">2. Add Circuit Breaker in Inventory Service WildFly Swarm Application</h2>
<div class="sectionbody">
<div class="paragraph"><p>WildFly Swarm provides the <code>hystrix</code> fraction, which manages dependencies to the Netflix OSS stack and allows the configuration of Hystrix defaults through Swarm configuration YAML files. However, protecting method calls with Hystrix requires direct interaction with the Hystrix APIs.</p></div>
<div class="sect2">
<h3 id="_update_project_to_include_circuit_breaker">2.1. Update Project to Include Circuit Breaker</h3>
<div class="paragraph"><p>In this section, you wrap the call to <code>InventoryResource</code> to retrieve the inventory from the database in a Hystrix circuit breaker.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the POM file of the inventory service project, add the <code>org.wildfly.swarm:hystrix:7.1.0.redhat-77</code> dependency. Note that at this moment the <code>hystrix</code> fraction is not included in the supported WildFly Swarm BOM, so the version (<code>7.1.0.redhat-77</code>) needs to be specified.
</p>
</li>
<li>
<p>
In the <code>InventoryResource</code> class, add a <code>hystrixCircuitBreakerRequestVolumeThreshold</code> field of type <code>int</code> and annotated with the <code>@Inject</code> and <code>@ConfigurationValue("hystrix.inventory.circuitBreaker.requestVolumeThreshold")</code> properties:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Inject
    @ConfigurationValue("hystrix.inventory.circuitBreaker.requestVolumeThreshold")
    private int hystrixCircuitBreakerRequestVolumeThreshold;</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Hystrix commands' default configuration values can be overridden using Swarm-managed configuration properties. For example, you can make the circuit breaker request volume threshold configurable. The threshold is the minimum number of requests in a rolling window that trip the circuit.
</p>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>InventoryResource</code> class, add a <code>hystrixGroupKey</code> field with type <code>String</code> and annotated with the <code>@Inject</code> and <code>@ConfigurationValue("hystrix.inventory.groupKey")</code> properties.
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Inject
    @ConfigurationValue("hystrix.inventory.groupKey")
    private String hystrixGroupKey;</code></pre>
</div></div>
</li>
<li>
<p>
In the <code>InventoryResource</code> class, create a nested class called <code>GetInventoryCommand</code> that extends <code>HystrixCommand&lt;Inventory&gt;</code>:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    class GetInventoryCommand extends HystrixCommand&lt;Inventory&gt; {

        private String itemId;

        public GetInventoryCommand(String itemId) {
            this.itemId = itemId;
        }

        @Override
        protected Inventory run() throws Exception {

        }
    }</code></pre>
</div></div>
</li>
<li>
<p>
In the constructor, set <code>GroupKey</code> for the Hystrix command as well as the request volume threshold configuration property:
</p>
<div class="listingblock">
<div class="content">
<pre><code>public GetInventoryCommand(String itemId) {
            super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(hystrixGroupKey))
                    .andCommandPropertiesDefaults(HystrixCommandProperties.Setter().
                            withCircuitBreakerRequestVolumeThreshold(hystrixCircuitBreakerRequestVolumeThreshold)));
            this.itemId = itemId;
        }</code></pre>
</div></div>
</li>
<li>
<p>
In the <code>run</code> method, call the <code>inventoryService.getInventory</code> method.
</p>
</li>
<li>
<p>
Modify the <code>InventoryResource.getInventory</code> method to instantiate and execute the Hystrix <code>GetInventoryCommand</code> command.
</p>
<div class="ulist"><ul>
<li>
<p>
Catch <code>HystrixRuntimeException</code> and then throw a <code>WebAppplicationException</code> with a 503 status code.
</p>
</li>
<li>
<p>
<code>HystrixRuntimeException</code> is thrown whenever the circuit breaker is open, catches an exception, or times out. In that case, the application returns a 503 HTTP status code. There is no fallback method for this circuit breaker.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Optionally, also wrap the call to the store service in the <code>StoreStatusService</code> class in a HystrixCommand. You can use the same Hystrix group key and volume threshold settings. In case of an <code>HystrixRuntimeException</code>, return "N/A".
</p>
</li>
<li>
<p>
In <code>project-local.yml</code> of the <code>src/main/resources</code> folder, add the following properties:
</p>
<div class="listingblock">
<div class="content">
<pre><code>hystrix:
  inventory:
    groupKey: InventoryGroup
    circuitBreaker:
      requestVolumeThreshold: 10</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
When deployed on OpenShift, these values are set through a ConfigMap.
</p>
</li>
</ul></div>
</li>
<li>
<p>
On a Java EE application server, applications should not manage their own threads, but rather rely on container-managed threads. Hystrix commands run in a separate thread-pool, managed by the Hystrix framework. When running on a Java EE application server, the Hystrix managed thread-pool can be substituted by a container managed thread pool.
</p>
<div class="ulist"><ul>
<li>
<p>
In the <code>com.redhat.coolstore.inventory</code> package, create a class <code>HystrixConfig</code>.
</p>
</li>
<li>
<p>
Annotate the class with <code>@ApplicationScoped</code>
</p>
</li>
<li>
<p>
Set the contents of the class to:
</p>
<div class="listingblock">
<div class="content">
<pre><code>package com.redhat.coolstore.inventory;

import java.util.concurrent.BlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

import javax.annotation.PostConstruct;
import javax.annotation.PreDestroy;
import javax.annotation.Resource;
import javax.enterprise.concurrent.ManagedThreadFactory;
import javax.enterprise.context.ApplicationScoped;
import javax.enterprise.context.Initialized;
import javax.enterprise.event.Observes;

import com.netflix.hystrix.Hystrix;
import com.netflix.hystrix.HystrixThreadPoolKey;
import com.netflix.hystrix.strategy.HystrixPlugins;
import com.netflix.hystrix.strategy.concurrency.HystrixConcurrencyStrategy;
import com.netflix.hystrix.strategy.properties.HystrixProperty;

@ApplicationScoped
public class HystrixConfig {

    // The default factory is used
    @Resource(lookup = "java:comp/DefaultManagedThreadFactory")
    ManagedThreadFactory threadFactory;

    // Initialize eagerly
    void init(@Observes @Initialized(ApplicationScoped.class) Object event) {
    }

    @PostConstruct
    public void onStartup() {
        HystrixPlugins.getInstance().registerConcurrencyStrategy(new HystrixConcurrencyStrategy() {
            @Override
            public ThreadPoolExecutor getThreadPool(HystrixThreadPoolKey threadPoolKey, HystrixProperty&lt;Integer&gt; corePoolSize,
                    HystrixProperty&lt;Integer&gt; maximumPoolSize, HystrixProperty&lt;Integer&gt; keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue) {
                return new ThreadPoolExecutor(corePoolSize.get(), maximumPoolSize.get(), keepAliveTime.get(), unit, workQueue, threadFactory);
            }
        });
    }

    @PreDestroy
    public void onShutdown() {
        Hystrix.reset(1, TimeUnit.SECONDS);
    }

}</code></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Execute the tests.
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ cd ~/lab/inventory-service

$ mvn clean test</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Expect all of the tests to pass.
</p>
</li>
</ul></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_test_circuit_breaker">2.2. Test Circuit Breaker</h3>
<div class="paragraph"><p>To test the circuit breaker, you must generate exceptions or time-outs from <code>InventoryService</code>. You accomplish this by using CDI specialization or alternatives to inject a mocked version of the service.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the <code>com.redhat.coolstore.inventory</code> package in the <code>src/test/java</code> folder, create a class called <code>ErrorInventoryService</code> that extends <code>InventoryService</code>.
</p>
</li>
<li>
<p>
Annotate the class with <code>@Specializes</code>.
</p>
</li>
<li>
<p>
Override the <code>getInventory</code> method to throw an exception or simulate a time-out for given values of <code>itemId</code>:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Override
    public Inventory getInventory(String itemId) {
        if ("error".equalsIgnoreCase(itemId)) {
            throw new RuntimeException();
        }
        if ("timeout".equalsIgnoreCase(itemId)) {
            try {
                Thread.sleep(1500);
            } catch (InterruptedException e) {
            }
        }
        return super.getInventory(itemId);
    }</code></pre>
</div></div>
</li>
<li>
<p>
In the <code>RestApiTest</code> class, write a test for a REST call to <code>/inventory/error</code>. Verify that this call returns a 503 HTTP status code.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_add_hystrix_configuration_properties_to_configmap">2.3. Add Hystrix Configuration Properties to ConfigMap</h3>
<div class="paragraph"><p>Before deploying the application to OpenShift, you add the Hystrix configuration properties to the <code>app-config</code> ConfigMap.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Add the properties to the <code>project-defaults.yml</code> file in the <code>etc</code> directory of the project:
</p>
<div class="listingblock">
<div class="content">
<pre><code>swarm:
  datasources:
    data-sources:
      InventoryDS:
        driver-name: postgresql
        connection-url: jdbc:postgresql://inventory-postgresql:5432/inventorydb
        user-name: jboss
        password: jboss

store:
  service:
    url: http://UPDATE.ME

hystrix:
  inventory:
    groupKey: InventoryGroup
    circuitBreaker:
      requestVolumeThreshold: 10</code></pre>
</div></div>
</li>
<li>
<p>
Optionally, you can set global Hystrix configuration properties using the <code>swarm.hystrix</code> prefix.
</p>
<div class="ulist"><ul>
<li>
<p>
For example, to set the sleep window&#8212;the amount of time after tripping the circuit to reject requests before allowing attempts again to determine if the circuit should again be closed&#8212;to 10 seconds (rather than the default of five seconds), configure as follows:
</p>
<div class="listingblock">
<div class="content">
<pre><code>swarm:
  datasources:
    data-sources:
      InventoryDS:
        driver-name: postgresql
        connection-url: jdbc:postgresql://inventory-postgresql:5432/inventorydb
        user-name: jboss
        password: jboss
  hystrix:
    command:
      default:
        circuitBreaker:
          sleepWindowInMilliseconds: 10000

store:
  service:
    url: http://UPDATE.ME

hystrix:
  inventory:
    groupKey: InventoryGroup
    circuitBreaker:
      requestVolumeThreshold: 10</code></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Update the <code>store.service.url</code> in the <code>project-defaults.yml</code> config file
</p>
<div class="ulist"><ul>
<li>
<p>
Retrieve the URL of the store service
</p>
<div class="listingblock">
<div class="content">
<pre><code>export STORE_URL=http://$(oc get route store-service -n $COOLSTORE_PRJ -o template --template='{{.spec.host}}')

echo $STORE_URL</code></pre>
</div></div>
</li>
<li>
<p>
Make updates in the <code>project-defaults.yml</code> config file accordingly.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Delete the existing ConfigMap:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc delete configmap inventory-service -n $COOLSTORE_PRJ</code></pre>
</div></div>
</li>
<li>
<p>
Recreate the ConfigMap:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc create configmap inventory-service --from-file=etc/project-defaults.yml -n $COOLSTORE_PRJ</code></pre>
</div></div>
</li>
<li>
<p>
Deploy the Coolstore inventory service application on OpenShift using the Fabric8 Maven plug-in:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ mvn clean fabric8:deploy -Popenshift -Dfabric8.namespace=$COOLSTORE_PRJ -DskipTests</code></pre>
</div></div>
</li>
<li>
<p>
Test the inventory service in the happy path
</p>
<div class="ulist"><ul>
<li>
<p>
Retrieve the URL of the inventory service application:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ export INVENTORY_URL=http://$(oc get route inventory-service -n $COOLSTORE_PRJ -o template --template='{{.spec.host}}')</code></pre>
</div></div>
</li>
<li>
<p>
Retrieve the inventory for a product:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ curl -X GET "$INVENTORY_URL/inventory/165613?storeStatus=true"</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre><code>{
  "itemId": "165613",
  "location": "Raleigh [CLOSED]",
  "quantity": 256,
  "link": "http://maps.google.com/?q=Raleigh"
}</code></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Test the circuit breaker is working as expected by scaling down the Inventory PostgreSQL pods to zero.
</p>
<div class="ulist"><ul>
<li>
<p>
Scale down the pod
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc scale --replicas=0 dc/inventory-postgresql</code></pre>
</div></div>
</li>
<li>
<p>
Wait until the pod is scaled down.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Attempt to retrieve the inventory for a product:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ curl -X GET "$INVENTORY_URL/inventory/165613?storeStatus=true"</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Expect to get an empty response.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Now let&#8217;s scale up the Inventory PostgreSQL.
</p>
<div class="ulist"><ul>
<li>
<p>
Scale down the pod
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc scale --replicas=1 dc/inventory-postgresql</code></pre>
</div></div>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The inventory service application may not recover when the database is brought down and up again. If this is the case, you can force a new deployment of the inventory service with this command:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ oc rollout latest inventory-service -n $COOLSTORE_PRJ</code></pre>
</div></div>
<div class="paragraph"><p>Or better, add the following to the datasource configuration settings in the Inventory service ConfigMap:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>        valid-connection-checker-class-name: org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLValidConnectionChecker
        exception-sorter-class-name: org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLExceptionSorter</code></pre>
</div></div>
</td>
</tr></table>
</div>
<div class="ulist"><ul>
<li>
<p>
Test the app again. Retrieve the inventory for a product:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ curl -X GET "$INVENTORY_URL/inventory/165613?storeStatus=true"</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre><code>{
  "itemId": "165613",
  "location": "Raleigh [CLOSED]",
  "quantity": 256,
  "link": "http://maps.google.com/?q=Raleigh"
}</code></pre>
</div></div>
</li>
</ul></div>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_circuit_breaker_in_inventory_service_wildfly_swarm_application_with_microprofile_fault_tolerance">3. Add Circuit Breaker in Inventory Service WildFly Swarm Application with MicroProfile Fault Tolerance</h2>
<div class="sectionbody">
<div class="paragraph"><p>The MicroProfile Fault Tolerance specification was added to MicroProfile 1.2. It aims at providing a standard and easy way to add resiliency to your microservice or other Java EE development.</p></div>
<div class="paragraph"><p>MicroProfile fault Tolerance is based on CDI, more precisely on the CDI interceptor implementation. The spec defines interceptor binding annotations to apply Fault Tolerance policies on a method execution or on a class. As such it decouples business logic from Fault Tolerance policies.</p></div>
<div class="paragraph"><p>Policies included in the Fault Tolerance specification are the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Timeout: applied with @Timeout annotation. It adds a timeout to the current operation.
</p>
</li>
<li>
<p>
Retry: applied with @Retry annotation. It adds retry behavior and allows its configuration on the current operation.
</p>
</li>
<li>
<p>
Fallback: applied with @Fallback annotation. It defines the code to execute, should the current operation fail.
</p>
</li>
<li>
<p>
Bulkhead: applied with @Bulkhead annotation. It isolates failures in the current operation to preserve execution of other operations.
</p>
</li>
<li>
<p>
Circuit Breaker: applied with @CircuitBreaker annotation. It provides an automatic fast failing execution to prevent overloading the system.
</p>
</li>
<li>
<p>
Asynchronous: applied with @Asynchronous annotation. It makes the current operation asynchronous (i.e. code will be invoked asynchronously).
</p>
</li>
</ul></div>
<div class="paragraph"><p>These policies can be combined on the same method or class. Note howecver that the <code>@TimeOut</code> annotation only works reliably on methods annotated with <code>@Asynchronous</code>. <code>@Bulkhead</code> is generally also used in combination with <code>@Asynchronous</code> to limit the number of threads in the asynchronous operation.</p></div>
<div class="paragraph"><p>Methods annotated with <code>@Asynchronous</code> should return a <code>Future</code>.</p></div>
<div class="paragraph"><p>The Wildfly Swarm implementation of MicroProfile Fault Tolerance uses Hystrix under the cover.</p></div>
<div class="sect2">
<h3 id="_add_microprofile_fault_tolerance_to_inventory_service">3.1. Add MicroProfile Fault Tolerance to Inventory Service</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The labs in this module use the original application code as starting point, without the modifications added by the previous labs.<br />
Start from a fresh clone of the inventory service source code material or create a new branch in your existing clone.</td>
</tr></table>
</div>
<div class="paragraph"><p>In this section lab, you wrap the call to the remote store service in a circuit breaker with a fall-back method.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the POM file of the catalog service project, add the <code>org.wildfly.swarm:hystrix</code> dependency. Note that at this moment the <code>hystrix</code> fraction is not included in the supported WildFly Swarm BOM, so the community version (<code>2017.10.2</code>) needs to be specified.
</p>
</li>
<li>
<p>
In the <code>StoreStatusService</code> class in the <code>om.redhat.coolstore.inventory.service</code> package, change the signature of the <code>storeStatus</code> method to rturn a <code>Future&lt;String</code> rather than a <code>String</code>.
</p>
</li>
<li>
<p>
Change the method implementation to match the new return type. Throw a <code>ServiceUnavailableException</code> if the return code is different from 200 or 404.
</p>
<div class="listingblock">
<div class="content">
<pre><code>    public Future&lt;String&gt; storeStatus(String store) {
        Response response = storeService.resolveTemplate("store", store).request(MediaType.APPLICATION_JSON).get();
        if (response.getStatus() == 200) {
            JsonObject jsonResponse = Json.createReader(new StringReader(response.readEntity(String.class))).readObject();
            return CompletableFuture.completedFuture(jsonResponse.getString("status"));
        } else if (response.getStatus() == 404) {
            return CompletableFuture.completedFuture("Not Found");
        } else {
            throw new ServiceUnavailableException();
        }
    }</code></pre>
</div></div>
</li>
<li>
<p>
Create a fallback method for the call to the store service. The fallback method should have the same signature as the method protected with the circuit breaker.
</p>
<div class="listingblock">
<div class="content">
<pre><code>    public Future&lt;String&gt; fallback(String store) {
        return CompletableFuture.completedFuture("N/A");
    }</code></pre>
</div></div>
</li>
<li>
<p>
Annotate the <code>storeStatus</code> with the MicroProfile Fault Tolerance annotations:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @CircuitBreaker(requestVolumeThreshold = 4, failureRatio=0.75)
    @Bulkhead
    @Timeout
    @Fallback(fallbackMethod = "fallback")
    @Asynchronous
    public Future&lt;String&gt; storeStatus(String store) {</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The annotation can be configured with annotation parameters, and come with sensible default values.
</p>
</li>
<li>
<p>
The default value for timeout is 1000 ms.
</p>
</li>
<li>
<p>
The default value for bulkhead is 10 concurrent invocations or threads.
</p>
</li>
<li>
<p>
The circuit breaker will trip open if 3 (4 x 0.75) failures occur among the rolling window of 4 consecutive invocations.
</p>
</li>
<li>
<p>
When the circuit trips open, the <code>fallback</code> method is executed until the circuit is closed again.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Change the implementation of the <code>getInventory</code> method in the <code>InventoryResource</code> class to match the new return type of the call to the <code>StoreStatusService</code> class:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    public Inventory getInventory(@PathParam("itemId") String itemId, @DefaultValue("false") @QueryParam("storeStatus") boolean storeStatus) {
         Inventory inventory = inventoryService.getInventory(itemId);
         if (inventory == null) {
             throw new NotFoundException();
         } else {
            if (storeStatus) {
                String status = null;
                try {
                    status = storeStatusService.storeStatus(inventory.getLocation()).get();
                } catch (Exception e) {
                    status = "Error";
                }
                inventory.setLocation(inventory.getLocation() + " [" + status + "]");
            }
            return inventory;
         }
     }</code></pre>
</div></div>
</li>
<li>
<p>
Deploy the inventory application to OpenShift with the Fabric8 Maven plug-in and test the behaviour of the circuit breaker by scaling down the store service.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_configuration_of_microprofile_fault_tolerance">3.2. Configuration of MicroProfile Fault Tolerance</h3>
<div class="paragraph"><p>The MicroProfile Fault Tolerance annotaions an be cofigured with annotation parameters. The configuration can also be externalized using MicroProfile Config. The MicroProfile  Config API provides a common way to retrieve configuration coming from a variety of sources (properties file, system properties, environment variables, etc.).</p></div>
<div class="paragraph"><p>To override Fault Tolerance annotation properties or their defaults, the config properties follow a naming convention in the form of <em>&lt;classname&gt;/&lt;methodname&gt;/&lt;annotation&gt;/&lt;parameter&gt;</em>.</p></div>
<div class="paragraph"><p>For example, to set the timeout value for the call to the store service to 500 ms instead of the default 1000 ms, the config property should be <code>com.redhat.coolstore.inventory.service.StoreStatusService/storeStatus/Timeout/value=500</code>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">On OpenShift, the recommended way to provide external configuration is with a ConfigMap. The Wildfly Swarm MicroProfile Config implementation has support for ConfigMaps through its directory-based configuration source: a ConfigMap can be mounted inside the application pod, where each key in the ConfigMap becomes a config property.
However, ConfigMap names do not accept <em>'/'</em> characters, so this technique cannot be used for Fault Tolerance configuration. Instead the key/value pairs will have to be added as system properties to the Java process.</td>
</tr></table>
</div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the <code>deployment.yml</code> file in the <code>src/main/fabric8</code> folder of the project, append the following to the <code>JAVA_OPTIONS</code> environment variable:
</p>
<div class="listingblock">
<div class="content">
<pre><code>-Dcom.redhat.coolstore.inventory.service.StoreStatusService/storeStatus/CircuitBreaker/requestVolumeThreshold=4 -Dcom.redhat.coolstore.inventory.service.StoreStatusService/storeStatus/CircuitBreaker/requestVolumeThreshold=2 -Dcom.redhat.coolstore.inventory.service.StoreStatusService/storeStatus/CircuitBreaker/failureRatio=1 -Dcom.redhat.coolstore.inventory.service.StoreStatusService/storeStatus/Timeout/value=250</code></pre>
</div></div>
</li>
<li>
<p>
Redeploy the inventory service with the Fabric8 Maven plug-in and test the circuit breaker and time-out behaviour.
</p>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_circuit_breaker_to_cart_service_in_spring_boot_application">4. Add Circuit Breaker to Cart Service in Spring Boot Application</h2>
<div class="sectionbody">
<div class="paragraph"><p>Spring Cloud provides integration with Hystrix through annotations. Methods in Spring components that should fail fast can be annotated with <code>@HystrixCommand</code>. Netflix OSS uses its own configuration management framework called <em>Archaius</em>. Spring Cloud provides a bridge to make the Spring-defined properties visible as Netflix Archaius properties. This means that Hystrix properties can be defined as Spring properties.</p></div>
<div class="sect2">
<h3 id="_add_circuit_breaker">4.1. Add Circuit Breaker</h3>
<div class="paragraph"><p>The Circuit Breaker pattern is particularly useful when calling external services. In this section, you wrap the calls from the cart service to the catalog service as a Hystrix command.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the POM file of the catalog service project, add the <code>org.springframework.cloud:spring-cloud-starter-hystrix:1.4.3.RELEASE</code> dependency.
</p>
</li>
<li>
<p>
Add the <code>@EnableCircuitBreaker</code> annotation to the <code>CartServiceApplication</code> class.
</p>
<div class="ulist"><ul>
<li>
<p>
Without this annotation the circuit breaker implementation cannot be enabled.
</p>
</li>
<li>
<p>
At runtime, the circuit breaker can be disabled by setting <code>spring.cloud.circuit.breaker.enabled</code> to false.
</p>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>CatalogServiceImpl</code> class, annotate the <code>getProduct</code> method with <code>@HystrixCommand</code>:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Override
    @HystrixCommand(commandKey = "CatalogService", fallbackMethod = "getFallbackProduct")
    public Product getProduct(String itemId) {
        // ...
    }</code></pre>
</div></div>
</li>
<li>
<p>
Implement the <code>getFallbackProduct</code> method.
</p>
<div class="ulist"><ul>
<li>
<p>
The method requires the same signature as the <code>getProduct</code> method. Expect the implementation to return <code>null</code>.
</p>
</li>
<li>
<p>
The Hystrix component and individual Hystrix commands can be configured using properties. See the <a href="https://github.com/Netflix/Hystrix/wiki/Configuration">Hystrix configuration wiki</a> for an extensive overview of Hystrix configuration properties.
</p>
</li>
<li>
<p>
For example, to set the timeout for the Hystrix command to 1000 milliseconds, add the following property to <code>application.properties</code>, so that if the <code>getProduct</code> method takes longer than one second to execute, Hystrix executes the fallback method:
</p>
<div class="listingblock">
<div class="content">
<pre><code>hystrix.command.CatalogService.execution.isolation.thread.timeoutInMilliseconds=1000</code></pre>
</div></div>
</li>
</ul></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_execute_and_fix_cart_service_application_tests">4.2. Execute and Fix Cart Service Application Tests</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Execute the cart service application tests.
</p>
<div class="paragraph"><p>Expect all tests to pass, except the <code>addItemToCartWhenCatalogServiceThrowsError</code> test in the <code>CartEndpointTest</code> class.<br />
This is expected, as before the introduction of Hystrix, any HTTP error thrown by the catalog service was propagated to the <code>CartEndpoint</code> class and from there to the caller as a 500 HTTP status code error. With the circuit breaker enabled, the fallback logic is called in case of an HTTP error returned, and the REST call to the cart service succeeds.<br />
Also note that the test classes in the <code>CatalogServiceImplTest</code> class still pass, despite that the injection of the Hystrix circuit breaker changes the semantics of the implementation. The reason is that the <code>CatalogServiceImpl</code> class is tested in isolation, outside of the Spring application context, and the <code>@Hystrix</code> annotation is not taken into account.
. Fix the <code>addItemToCartWhenCatalogServiceThrowsError</code> test in the <code>CartEndpointTest</code> class.</p></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_deploy_application_to_openshift_and_test">4.3. Deploy Application to OpenShift and Test</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Deploy the application to OpenShift and test its behavior with <code>curl</code>.
</p>
</li>
<li>
<p>
Verify that the circuit breaker is working as expected by scaling down the catalog service to zero pods:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc scale dc catalog-service --replicas=0 -n $CATALOG_PRJ</code></pre>
</div></div>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_circuit_breaker_to_gateway_spring_boot_camel_application">5. Add Circuit Breaker to Gateway Spring Boot/Camel Application</h2>
<div class="sectionbody">
<div class="paragraph"><p>Apache Camel comes with the Hystrix EIP which provides integration with Netflix Hystrix to be used as a circuit breaker in the Camel routes. The EIP offers a rich DSL for fine-grained configuration of the circuit breaker.</p></div>
<div class="paragraph"><p>In this section, you add the Hystrix EIP to the routes defined in the Coolstore gateway application.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the POM file of the Coolstore gateway project, add the <code>org.apache.camel:camel-hystrix-starter</code> dependency.
</p>
</li>
<li>
<p>
In the <code>CartGateway</code> class in the <code>com.redhat.coolstore.api.gateway</code> package, add the following fields annotated with the <code>@Value</code> annotation:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Value("${hystrix.cart.executionTimeout}")
    private int hystrixExecutionTimeout;

    @Value("${hystrix.cart.groupKey}")
    private String hystrixGroupKey;

    @Value("${hystrix.cart.circuitBreakerEnabled}")
    private boolean hystrixCircuitBreakerEnabled;</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
These represent Hystrix configuration parameters, injected through Spring.
</p>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">There are many more configuration parameters that can be set on the Hystrix command. These are just some examples.</td>
</tr></table>
</div>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>CartGateway</code> class, in the <code>configure</code> method, wrap <code>getCartRoute</code> into a Hystrix call:
</p>
<div class="listingblock">
<div class="content">
<pre><code>        .get("/{cartId}").description("Get the current user's shopping cart content")
            .param().name("cartId").type(RestParamType.path).description("The ID of the cart to process").dataType("string").endParam()
            .outType(ShoppingCart.class)
            .route().id("getCartRoute")
                .hystrix().id("Cart Service (Get Cart)")
                    .hystrixConfiguration()
                        .executionTimeoutInMilliseconds(hystrixExecutionTimeout)
                        .groupKey(hystrixGroupKey)
                        .circuitBreakerEnabled(hystrixCircuitBreakerEnabled)
                    .end()
                    .removeHeaders("CamelHttp*")
                    .setBody().simple("null")
                    .setHeader(Exchange.CONTENT_TYPE, simple(MediaType.APPLICATION_JSON_VALUE))
                    .setHeader(Exchange.HTTP_METHOD, HttpMethods.GET)
                    .setHeader(Exchange.HTTP_PATH, simple("cart/${header.cartId}"))
                    .setHeader(Exchange.HTTP_URI, simple("{{cart.service.url}}"))
                    .to("http4://DUMMY")
                    .to("direct:cartServiceSuccess")
                .onFallback()
                    .to("direct:defaultFallback")
                .end()
        .endRest()</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Note the fluent DSL for Hystrix command configuration. The different methods on the <code>HystrixConfigurationDefinition</code> object returned by <code>hystrixConfiguration()</code> give a complete overview of what can be configured. Configuration parameters that are not explicitly set inherit from the Hystrix default values.
</p>
</li>
<li>
<p>
If the call succeeds, the route continues in the <code>direct:cartServiceSuccess</code> route.
</p>
</li>
<li>
<p>
If the call fails, the  <code>direct:defaultFallback</code> fallback route is called.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Add <code>direct:cartServiceSuccess</code> and <code>direct:defaultFallback</code> to the <code>configure</code> method:
</p>
<div class="listingblock">
<div class="content">
<pre><code>        from("direct:cartServiceSuccess").routeId("cartservicesuccess")
            .setHeader("CamelJacksonUnmarshalType", simple(ShoppingCart.class.getName()))
            .unmarshal().json(JsonLibrary.Jackson, ShoppingCart.class);

        from("direct:defaultFallback").routeId("defaultfallback").description("Default Fall back response response")
            .process(new Processor() {
                @Override
                public void process(Exchange exchange) throws Exception {
                    exchange.getIn().setBody("Cart service is unavailable");
                    exchange.getIn().setHeader(Exchange.CONTENT_TYPE, "text/plain");
                    exchange.getIn().setHeader(Exchange.HTTP_RESPONSE_CODE, 503);
                    exchange.setOut(exchange.getIn());
                }
            });</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The fallback route sends back a 503 HTTP status code, marking the cart service as unavailable.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Repeat this for the <code>addToCartRoute</code>, <code>deleteFromCartRoute</code>, and <code>checkoutRoute</code> routes.
</p>
</li>
<li>
<p>
In the <code>application-test.properties</code> in the <code>src/test/resources</code> folder, add the following properties:
</p>
<div class="listingblock">
<div class="content">
<pre><code>hystrix.cart.groupKey=cart
hystrix.cart.executionTimeout=2000
hystrix.cart.circuitBreakerEnabled=true</code></pre>
</div></div>
</li>
<li>
<p>
Run the test for the application.
</p>
<div class="ulist"><ul>
<li>
<p>
Expect all of the tests to pass.
</p>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>CartGatewayTest</code> class, add a test method for the <code>getCartRoute</code> to verify that a 503 HTTP status code is returned whenever the mocked cart service responds with an error.
</p>
</li>
<li>
<p>
Add equivalent test methods for the other REST endpoints.
</p>
</li>
<li>
<p>
In the <code>ProductGateway</code> class in the <code>com.redhat.coolstore.api.gateway</code> package, add the following fields annotated with the <code>@Value</code> annotation:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Value("${hystrix.products.executionTimeout}")
    private int hystrixProductsExecutionTimeout;

    @Value("${hystrix.products.groupKey}")
    private String hystrixProductsGroupKey;

    @Value("${hystrix.products.circuitBreakerEnabled}")
    private boolean hystrixProductsCircuitBreakerEnabled;

    @Value("${hystrix.inventory.executionTimeout}")
    private int hystrixInventoryExecutionTimeout;

    @Value("${hystrix.inventory.groupKey}")
    private String hystrixInventoryGroupKey;

    @Value("${hystrix.inventory.circuitBreakerEnabled}")
    private boolean hystrixInventoryCircuitBreakerEnabled;</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The product gateway involves two remote services that are each wrapped in their own Hystrix command and are separately configurable.
</p>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>ProductGateway</code> class, modify the <code>configure</code> method to wrap the outgoing calls in a Hystrix command:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Override
    public void configure() throws Exception {

        JacksonDataFormat productFormatter = new ListJacksonDataFormat();
        productFormatter.setUnmarshalType(Product.class);

        restConfiguration("product")
            .component("servlet")
            .bindingMode(RestBindingMode.json)
            .enableCORS(true);

        rest("/products/").description("Product Catalog Service")
            .produces(MediaType.APPLICATION_JSON_VALUE)

        .get("/").description("Get Product Catalog").outType(Product.class)
            .route().id("productRoute")
                .hystrix().id("Product Service")
                    .hystrixConfiguration()
                        .executionTimeoutInMilliseconds(hystrixProductsExecutionTimeout)
                        .groupKey(hystrixProductsGroupKey)
                        .circuitBreakerEnabled(hystrixProductsCircuitBreakerEnabled)
                    .end()
                    .setBody(simple("null"))
                    .removeHeaders("CamelHttp*")
                    .setHeader(Exchange.CONTENT_TYPE, simple(MediaType.APPLICATION_JSON_VALUE))
                    .setHeader(Exchange.HTTP_METHOD, HttpMethods.GET)
                    .setHeader(Exchange.HTTP_PATH, simple("products"))
                    .setHeader(Exchange.HTTP_URI, simple("{{catalog.service.url}}"))
                    .to("http4://DUMMY")
                    .unmarshal(productFormatter)
                .onFallback()
                    .to("direct:productFallback")
                    .stop()
                .end()
            .split(body()).parallelProcessing()
                .enrich("direct:inventory", new InventoryEnricher())
            .end()
        .endRest();

       from("direct:inventory")
            .id("inventoryRoute")
            .setHeader("itemId", simple("${body.itemId}"))
            .hystrix().id("Inventory Service")
                .hystrixConfiguration()
                    .executionTimeoutInMilliseconds(hystrixInventoryExecutionTimeout)
                    .groupKey(hystrixInventoryGroupKey)
                    .circuitBreakerEnabled(hystrixInventoryCircuitBreakerEnabled)
                .end()
                .setBody(simple("null"))
                .removeHeaders("CamelHttp*")
                .setHeader(Exchange.CONTENT_TYPE, simple(MediaType.APPLICATION_JSON_VALUE))
                .setHeader(Exchange.HTTP_METHOD, HttpMethods.GET)
                .setHeader(Exchange.HTTP_PATH, simple("api/inventory/${header.itemId}"))
                .setHeader(Exchange.HTTP_URI, simple("{{inventory.service.url}}"))
                .to("http4://DUMMY1")
            .onFallback()
                .to("direct:inventoryFallback")
            .end()
            .setHeader("CamelJacksonUnmarshalType", simple(Inventory.class.getName()))
            .unmarshal().json(JsonLibrary.Jackson, Inventory.class);

        from("direct:productFallback")
            .id("ProductFallbackRoute")
            .transform()
            .constant(Collections.singletonList(getFallBackProduct()));

        from("direct:inventoryFallback")
            .id("inventoryFallbackRoute")
            .transform()
            .constant(getFallbackInventory())
            .marshal().json(JsonLibrary.Jackson, Inventory.class);

    }</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Note that if the call to catalog service fails, the inventory service is not called anymore (<code>stop</code> directive after the routing to <code>direct:productFallback</code>).
</p>
</li>
</ul></div>
</li>
<li>
<p>
Add the missing <code>getFallbackProduct</code> and <code>getFallbackInventory</code> methods:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    private Product getFallbackProduct() {
        Product product = new Product();
        product.setItemId("0");
        product.setName("Unavailable Product");
        product.setDesc("Unavailable Product");
        product.setPrice(0);
        product.setAvailability(getFallbackInventory());
        return product;
    }

    private Inventory getFallbackInventory() {
        Inventory inventory = new Inventory();
        inventory.setItemId("0");
        inventory.setQuantity(0);
        inventory.setLocation("Local Store");
        inventory.setLink("http://developers.redhat.com");
        return inventory;
    }</code></pre>
</div></div>
</li>
<li>
<p>
In <code>application-test.properties</code> in the <code>src/test/resources</code> folder, add the following properties:
</p>
<div class="listingblock">
<div class="content">
<pre><code>hystrix.products.groupKey=product
hystrix.products.executionTimeout=1000
hystrix.products.circuitBreakerEnabled=true
hystrix.inventory.groupKey=inventory
hystrix.inventory.executionTimeout=1000
hystrix.inventory.circuitBreakerEnabled=true</code></pre>
</div></div>
</li>
<li>
<p>
Run the tests for the application.
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ cd ~/lab/gateway-service

$ mvn clean test</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Expect all of the tests to pass.
</p>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>ProductGatewayTest</code> class, add test methods for <code>productRoute</code> to verify that the fallbacks are correctly invoked whenever the mocked catalog service or inventory service respond with an error.
</p>
</li>
<li>
<p>
Update the <code>gateway-service</code> ConfigMap in the gateway project on OpenShift with <code>application.properties</code>.
</p>
</li>
<li>
<p>
Add the following properties
</p>
<div class="listingblock">
<div class="content">
<pre><code>hystrix.cart.groupKey=cart
hystrix.cart.executionTimeout=2000
hystrix.cart.circuitBreakerEnabled=true
hystrix.products.groupKey=product
hystrix.products.executionTimeout=1000
hystrix.products.circuitBreakerEnabled=true
hystrix.inventory.groupKey=inventory
hystrix.inventory.executionTimeout=1000
hystrix.inventory.circuitBreakerEnabled=true</code></pre>
</div></div>
</li>
<li>
<p>
Deploy the application to OpenShift using the Fabric8 Maven plug-in
</p>
<div class="listingblock">
<div class="content">
<pre><code>mvn clean fabric8:deploy -Popenshift -Dfabric8.namespace=$COOLSTORE_PRJ</code></pre>
</div></div>
</li>
<li>
<p>
Test its behavior using <code>curl</code>.
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ export GATEWAY_URL=http://$(oc get route gateway-service -n $COOLSTORE_PRJ -o template --template='{{.spec.host}}')</code></pre>
</div></div>
</li>
<li>
<p>
Get all products
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ curl -X GET "$GATEWAY_URL/api/products"</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
You can verify that the circuit breaker is working as expected by scaling down the catalog service or cart service pods to zero.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Scale down the catalog service
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc scale --replicas=0 dc/catalog-service</code></pre>
</div></div>
</li>
<li>
<p>
Test the gateway service and verify circuit breaker is working was expected.
</p>
</li>
<li>
<p>
Scale up the catalog service to confirm happy path.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect1">
<h2 id="_optional_lab_propagate_jwt_token_when_using_hystrix">6. Optional Lab: Propagate JWT Token when using Hystrix</h2>
<div class="sectionbody">
<div class="paragraph"><p>When securing a microservice application with RHSSO and JWT, the token is generally stored as a thread-local variable after successful authentication and authorization. When calling a secured external service which requires the token to be added to the headers of the outgoing call, the token can be extracted from the thread-local variable.</p></div>
<div class="paragraph"><p>However, Hystrix commands are executed in their own thread pool, which means that the Hystrix thread has no access to the JWT token stored in the security context. To fix this, the security context thread-local variable containing the JWT token must be made available to the Hystrix request context. How to do this depends on the framework used. In this section the steps required for a Spring Boot application are detailed.</p></div>
<div class="paragraph"><p>For this lab, the starting point is the secured cart service codebase, which the changes introduced in the <code>Securing Microservices</code> lab.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Deploy the secured catalog service to OpenShift. Refer to the instructions in the <code>Securing Microservices</code> lab.
</p>
</li>
<li>
<p>
Verify using <code>curl</code> that the catalog service API is secured and requires a valid JWT token.
</p>
</li>
<li>
<p>
In the cart service application code, wrap the call to the catalog service in a Hystrix command. Follow the instructions as detailed above to do so.
</p>
</li>
<li>
<p>
Ignore the failing tests for now&#8212;you will fix them later.
</p>
</li>
<li>
<p>
Deploy the cart service application to OpenShift.
</p>
</li>
<li>
<p>
Test the cart service using <code>curl</code>.<br />
Note that you cannot add products to the cart&#8212;the cart remains empty.
</p>
<div class="paragraph"><p>The JWT token is no longer propagated to the catalog service, as result the call to the catalog service fails and the Hystrix circuit breaker kicks in.
. Create a servlet filter class in the <code>com.redhat.coolstore.cart</code> package to enable the Hystrix request context for every REST call:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>public class HystrixRequestContextFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        HystrixRequestContext context = HystrixRequestContext.initializeContext();
        try {
            filterChain.doFilter(request, response);
        } finally {
            context.shutdown();
        }
    }
}</code></pre>
</div></div>
</li>
<li>
<p>
Create a holder class for the Hystrix request variable to hold the Spring Security context object:
</p>
<div class="listingblock">
<div class="content">
<pre><code>public class SecurityContextHystrixRequestVariable {
    private static final HystrixRequestVariableDefault&lt;SecurityContext&gt; securityContextVariable = new HystrixRequestVariableDefault&lt;&gt;();

    private SecurityContextHystrixRequestVariable() {
    }

    public static HystrixRequestVariableDefault&lt;SecurityContext&gt; getInstance() {
        return securityContextVariable;
    }
}</code></pre>
</div></div>
</li>
<li>
<p>
Create a servlet filter to include the Spring Security context object in a Hystrix request variable using the holder class you just created:
</p>
<div class="listingblock">
<div class="content">
<pre><code>public class SecurityContextHystrixRequestVariableSetterFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        SecurityContextHystrixRequestVariable.getInstance().set(SecurityContextHolder.getContext());
        filterChain.doFilter(request, response);
    }

}</code></pre>
</div></div>
</li>
<li>
<p>
Create a Hystrix command hook that extracts <code>SecurityContext</code> from the <code>SecurityContextHystrixRequestVariable</code> and sets it on <code>SecurityContextHolder</code>:
</p>
<div class="listingblock">
<div class="content">
<pre><code>public class SecurityContextRegistrarCommandHook extends HystrixCommandExecutionHook {

    @Override
    public &lt;T&gt; void onRunStart(HystrixCommand&lt;T&gt; commandInstance) {
        SecurityContextHolder.setContext(SecurityContextHystrixRequestVariable.getInstance().get());
    }

    @Override
    public &lt;T&gt; T onComplete(HystrixCommand&lt;T&gt; commandInstance, T response) {
        SecurityContextHolder.clearContext();
        return response;
    }

    @Override
    public &lt;T&gt; Exception onError(HystrixCommand&lt;T&gt; commandInstance, FailureType failureType, Exception e) {
        SecurityContextHolder.clearContext();
        return e;
    }

}</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The hook sets <code>SecurityContext</code> when the Hystrix command is about to start and clears the context when the command completes successfully or unsuccessfully.
</p>
</li>
<li>
<p>
The <code>SecurityContext.setContext</code> call stores the context as a thread-local variable belonging to the Hystrix-managed thread that executes the command.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Because this is a Spring Boot application, you can use an implementation of <code>CommandLineRunner</code> to register the Hystrix command hook with the Hystrix engine on application startup:
</p>
<div class="listingblock">
<div class="content">
<pre><code>@Component
public class HystrixPluginRegistrar implements CommandLineRunner {

    @Override
    public void run(String... args) throws Exception {
        HystrixPlugins.getInstance().registerCommandExecutionHook(new SecurityContextRegistrarCommandHook());
    }

}</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
This class is executed immediately after the Spring context is initialized.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Register the two servlet filters created previously with the servlet engine:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);
        http.addFilterAfter(new HystrixRequestContextFilter(), KeycloakAuthenticationProcessingFilter.class);
        http.addFilterAfter(new SecurityContextHystrixRequestVariableSetterFilter(), HystrixRequestContextFilter.class);
        http.csrf().disable().authorizeRequests().antMatchers("/cart/**").hasRole("coolstore").anyRequest().permitAll();
    }</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The filters must be registered after the Keycloak authentication filter to make sure that the Spring Security context is initialized first. This can be done in the <code>configure</code> method of the <code>CartServiceSecurityConfig</code> class.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Run the tests again.
</p>
<div class="ulist"><ul>
<li>
<p>
Expect the tests to pass now.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Deploy the cart service to OpenShift.
</p>
</li>
<li>
<p>
Test the cart service using <code>curl</code>.<br />
Expect the cart service functionality to work as expected&#8212;items can be added to the cart.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Congratulations, you reached the end of the lab.</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2018-10-26 04:51:08 EDT
</div>
</div>
</body>
</html>
