<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.8" />
<title></title>
<style type="text/css">
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .mathblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #003b6b; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #00579e; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #333333; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: Arial, sans-serif; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Arial, sans-serif; font-weight: normal; font-style: normal; color: #7b2d00; text-rendering: optimizeLegibility; margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #ff6b15; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: #003426; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; list-style-position: outside; font-family: Arial, sans-serif; }

ul, ol { margin-left: 1.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3em; font-weight: bold; }
dl dd { margin-bottom: 0.75em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: black; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #e15200; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #e15200; }

blockquote, blockquote p { line-height: 1.6; color: #333333; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
  h4 { font-size: 1.4375em; } }
/* Print styles.  Inlined to avoid required HTTP connection: www.phpied.com/delay-loading-your-print-css/ Credit to Paul Irish and HTML5 Boilerplate (html5boilerplate.com)
*/
.print-only { display: none !important; }

@media print { * { background: transparent !important; color: #000 !important; /* Black prints faster: h5bp.com/s */ box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; /* h5bp.com/t */ }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #d8d8ce; }
/* Change -webkit-linear-gradient colors to  #a70000 and remove gradient */
table thead, table tfoot { background: -webkit-linear-gradient(top, #a70000, #a70000); font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: white; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #6d6e71; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #edf2f2; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; padding: 3px 2px 1px 2px; white-space: nowrap; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; text-shadow: none; }

pre, pre > code { line-height: 1.6; color: black; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

kbd.keyseq { color: #333333; }

kbd:not(.keyseq) { display: inline-block; color: black; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

kbd kbd:first-child { margin-left: 0; }

kbd kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: black; }

b.button:before { content: '[ '; }

b.button:after { content: ' ]'; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 1.5em; padding-right: 1.5em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#header { margin-bottom: 2.5em; }
#header > h1 { color: #7b2d00; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #333333; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }

#toc { border-bottom: 1px solid #dddddd; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }

#toctitle { color: #003b6b; }

@media only screen and (min-width: 768px) { body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: .90em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; border-width: 0; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }

#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }

#footer { max-width: 100%; background-color: none; padding: 1.25em; }

#footer-text { color: black; line-height: 1.44; }

.sect1 { padding-bottom: 1.25em; }

.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #7b2d00; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #622400; }

.imageblock, .literalblock, .listingblock, .mathblock, .verseblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .mathblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }

.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #333333; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }

.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #aaaaaa; box-shadow: 0 1px 8px #aaaaaa; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #003b6b; margin-top: 0; line-height: 1.6; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre:not([class]), .listingblock pre:not([class]) { background: #eeeeee; }
.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border-width: 1px; border-style: dashed; border-color: #666666; -webkit-border-radius: 0; border-radius: 0; padding: 1.25em 1.5625em 1.125em 1.5625em; word-wrap: break-word; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock pre > code, .literalblock pre[class] > code, .listingblock pre > code, .listingblock pre[class] > code { display: block; }
@media only screen { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.72em; } }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.81em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.9em; } }

.listingblock pre.highlight { padding: 0; }
.listingblock pre.highlight > code { padding: 1.25em 1.5625em 1.125em 1.5625em; }

.listingblock > .content { position: relative; }

.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }

.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.sass:before { content: "sass"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }

table.pyhltable { border: 0; margin-bottom: 0; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }

.quoteblock { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 0.75em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: 0.8125em; color: #e15200; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }

table thead th, table tfoot th { font-weight: bold; }

table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 0; border-radius: 0; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }

table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }

table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }

table.tableblock td .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }

th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }

th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }

th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }

th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }

th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }

tbody tr th { display: table-cell; line-height: 1.4; background: -webkit-linear-gradient(top, #add386, #90b66a); }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: white; font-weight: bold; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.375em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.375em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .8em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.qanda > ol > li > p > em:only-child { color: #004985; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }

.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #00579e; color: #004176; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum { display: inline-block; color: white !important; background-color: black; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { border-bottom: 1px solid #dddddd; }

#toctitle { color: #00406F; font-weight: normal; margin-top: 1.5em; }

.sidebarblock { border-color: #aaa; }

code { -webkit-border-radius: 4px; border-radius: 4px; }

p.tableblock.header { color: #6d6e71; }


@media screen {
  body {
    max-width: 80em; /* 50em is approximately 80 characters wide */
    margin-left: 20em; /* this is 3em beyound the width of the toc */
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 20em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
    font-size: 0.9em;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    padding-left: 1.25em;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_asynchronous_communication_lab">Asynchronous Communication Lab</h2>
<div class="sectionbody">
<div class="paragraph"><p>The microservices developed in the previous labs all used REST over HTTP to communicate with each other. In this lab, you will use messaging to exchange information between microservices.</p></div>
<div class="paragraph"><p>In this lab, you use EnMasse as messaging infrastructure solution. EnMasse is an open source messaging platform that runs on OpenShift. It is based on AMQ 7 (Apache ActiveMQ Artemis and Apache Qpid Dispatch Router). Enmasse is the upstream for the soon-to-be-released Red Hat OpenShift Messaging product.</p></div>
<div class="ulist"><div class="title">Goals</div><ul>
<li>
<p>
Update the cart service application to send messages to a topic hosted on EnMasse upon cart checkout.
</p>
</li>
<li>
<p>
Develop a prototype checkout service to consume the messages from the EnMasse topic.
</p>
</li>
<li>
<p>
Deploy the applications to OpenShift
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Prerequisite</div><ul>
<li>
<p>
Completion of the Spring Boot lab
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The labs in this module use the original application code as starting point, without the modifications added by the previous labs.<br />
Before starting the lab, make fresh clones of the lab source code material and redeploy the different microservice applications using the Fabric8 Maven plugin. Alternatively, create separate branches in the lab source code for the different labs.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_enmasse_on_openshift">1. Deploy EnMasse on OpenShift</h2>
<div class="sectionbody">
<div class="paragraph"><p>EnMasse is the upstream project of Red Hat OpenShift Messaging (RHOM), which has not been released yet. In this lab you will use the upstream EnMasse project.</p></div>
<div class="paragraph"><p>EnMasse has the following features:</p></div>
<div class="ulist"><ul>
<li>
<p>
Handles different communication patterns like request-response, pub-sub and events
</p>
</li>
<li>
<p>
Provides an address model and an API for managing messaging infrastructure
</p>
</li>
<li>
<p>
Supports multitenancy with multiple isolated address spaces
</p>
</li>
<li>
<p>
Supports authentication of clients and identity management using keycloak
</p>
</li>
<li>
<p>
Built on Kubernetes/OpenShift: deploy on-premise or in the cloud
</p>
</li>
</ul></div>
<div class="paragraph"><p>EnMasse supports a <strong>standard</strong> and a <strong>brokered</strong> address space types, each with different semantics.</p></div>
<div class="paragraph"><p>The standard address space type is the default type in EnMasse, and is focused on scaling in the number of connections and the throughput of the system. It supports AMQP and MQTT protocols, with more to come in the future.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/enmasse-architecture-standard.png" alt="images/enmasse-architecture-standard.png" />
</div>
</div>
<div class="paragraph"><p>The brokered address space type is the “classical” message broker in the cloud. It supports JMS with transactions, message groups, selectors on queues etc. These kind of features are powerful in building complex messaging patterns. This address space is also the most light weight as it features only a single broker + a management console.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/enmasse-architecture-brokered.png" alt="images/enmasse-architecture-brokered.png" />
</div>
</div>
<div class="paragraph"><p>More information at the <a href="http://enmasse.io">EnMasse web site</a>.</p></div>
<div class="paragraph"><p>In this lab you will use a brokered address space.</p></div>
<div class="sect2">
<h3 id="_deploy_enmasse">1.1. Deploy EnMasse</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a project in OpenShift for Enmasse, prefixing the project names with your name or initials:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc new-project &lt;your name&gt;-enmasse</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
If you are using the provided shared OpenShift environment, project names must be unique across the cluster.
</p>
</li>
<li>
<p>
Alternatively, you can create the projects through the OpenShift web console.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Install EnMasse on OpenShift using the installation script in the <code>ocp/enmasse</code> folder of the lab source code material.
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ export ENMASSE_PRJ=&lt;name of your OpenShift enmasse project&gt;
$ export OCP_MASTER=&lt;OpenShift master url&gt;
$ export OCP_USER=&lt;Openshift user&gt;
$ ./ocp/enmasse/deploy-openshift.sh -a "none standard" -n $ENMASSE_PRJ -m $OCP_MASTER -o singletenant -u $OCP_USER</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre><code>Logged into "https://master.dev37.openshift.opentlc.com:443" as "btison-redhat.com" using existing credentials
You have access to the following projects and can switch between them with 'oc project &lt;projectname&gt;':
  * bt-enmasse
    bt-coolstore

Using project "bt-enmasse".
Already on project "bt-enmasse" on server "https://master.dev37.openshift.opentlc.com:443".
serviceaccount "enmasse-admin" created
role "view" added: "system:serviceaccount:bt-enmasse:default"
role "admin" added: "system:serviceaccount:bt-enmasse:enmasse-admin"
Generating a 2048 bit RSA private key
...........................+++
........+++
writing new private key to '/tmp/enmasse-deploy.lWFvwo/address-controller.bt-enmasse.svc.cluster.local.key'

secret "address-controller-cert" created
Generating a 2048 bit RSA private key
.............................................+++
...+++
writing new private key to '/tmp/enmasse-deploy.lWFvwo/none-authservice.bt-enmasse.svc.cluster.local.key'

secret "none-authservice-cert" created
deployment "none-authservice" created
service "none-authservice" created
Generating a 2048 bit RSA private key
........+++
.........+++
writing new private key to '/tmp/enmasse-deploy.hFH8KQ/standard-authservice.enmasse.svc.cluster.local.key'

secret "standard-authservice-cert" created
secret "keycloak-credentials" created
persistentvolumeclaim "keycloak-pvc" created
deployment "keycloak" created
deployment "keycloak-controller" created
service "standard-authservice" created
route "keycloak" created
configmap "keycloak-config" created
configmap "resource-definition-router" created
configmap "resource-definition-broker-topic" created
configmap "resource-definition-broker" created
configmap "address-space-plan-standard" created
configmap "address-space-plan-standard-mqtt" created
configmap "resource-definition-standard" created
configmap "resource-definition-standard-mqtt" created
configmap "address-plan-sharded-queue" created
configmap "address-plan-pooled-queue" created
configmap "address-plan-standard-anycast" created
configmap "address-plan-standard-multicast" created
configmap "address-plan-sharded-topic" created
configmap "address-plan-pooled-topic" created
serviceaccount "address-space-admin" created
role "admin" added: "system:serviceaccount:bt-enmasse:address-space-admin"
template "standard-space-infra-without-mqtt" created
template "standard-space-infra" created
template "brokered-space-infra" created
deployment "address-controller" created
service "address-controller" created
route "restapi" created</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
4 pods are created in the EnMasse project:
</p>
<div class="ulist"><ul>
<li>
<p>
address-controller: exposes a REST API to create address spaces and addresses.
</p>
</li>
<li>
<p>
keycloak: provides the authentication service for the broker.
</p>
</li>
<li>
<p>
keycloak-controller: exposes a REST API to keycloak for use by the address-controller.
</p>
</li>
<li>
<p>
non-authentication-service: dummy authentication service for the broker.
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Check using the OpenShift web console that the 4 pods are deployed successfully. Or using the <code>oc</code> command line client:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc get pods -n $ENMASSE_PRJ</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre><code>NAME                                   READY     STATUS    RESTARTS   AGE
address-controller-48287195-rjn8l      1/1       Running   0          11m
keycloak-1619414227-bbbmj              1/1       Running   0          11m
keycloak-controller-1233449958-nxzcn   1/1       Running   0          11m
none-authservice-3369882979-8l692      1/1       Running   0          11m</code></pre>
</div></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_create_brokered_address_space">1.2. Create Brokered Address Space</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a JSON payload for the EnMasse address controller REST API:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ read -r -d '' _DATA_JSON &lt;&lt; EOM
{
  "kind": "AddressSpace",
  "apiVersion": "enmasse.io/v1",
  "metadata": {
    "name": "brokered-default",
    "namespace": "$ENMASSE_PRJ"
  },
  "spec": {
    "type": "brokered",
    "plan": "unlimited-brokered",
    "authenticationService": {
      "type": "standard"
    }
  }
}
EOM</code></pre>
</div></div>
</li>
<li>
<p>
Create the address space
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ export TOKEN=`oc whoami -t`
$ curl -X POST -d "$_DATA_JSON" -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN" -k https://$(oc get route restapi -o jsonpath='{.spec.host}' -n $ENMASSE_PRJ)/apis/enmasse.io/v1/addressspaces</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre><code>{"apiVersion":"enmasse.io/v1","kind":"AddressSpaceList","items":[{"metadata":{"name":"brokered-default","namespace":"enmasse","createdBy":"anonymous"},"spec":{"type":"brokered","plan":"unlimited","authenticationService":{"type":"standard","details":{}}},"status":{"isReady":false}}]}</code></pre>
</div></div>
</li>
<li>
<p>
Check using the OpenShift web console that a broker and an agent pod are deployed successfully in the EnMasse namespace. Or using the <code>oc</code> command line client:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc get pods -n $ENMASSE_PRJ</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre><code>NAME                                   READY     STATUS    RESTARTS   AGE
address-controller-48287195-rjn8l      1/1       Running   0          2h
agent-1476773799-zc4th                 1/1       Running   0          3m
broker-3425684911-rx65n                1/1       Running   0          3m
keycloak-1619414227-bbbmj              1/1       Running   0          2h
keycloak-controller-1233449958-nxzcn   1/1       Running   0          2h
none-authservice-3369882979-8l692      1/1       Running   0          2h</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The agent pod exposes the EnMasse console.
</p>
</li>
<li>
<p>
The broker pod runs the AMQ 7 broker.
</p>
</li>
</ul></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_create_user_on_keycloak">1.3. Create User on Keycloak</h3>
<div class="paragraph"><p>In order to be able to receive and send messages, as well as use the EnMasse console, at least one user must be created in the Keycloak realm corrsponding to the EnMasse address space.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Obtain the username and password to the Keycloak administration console. The username and password are stored in the <code>keycloak-credentials</code> secret in the Enmasse namespace.<br />
In the OpenShift web console, navigate to the EnMasse namespace, open the <code>Resources -&gt; Secrets</code> page, and select the <code>keycloak-credentials</code> secret. Click on the <code>Reveal Secret</code> link to reveal the username and password.
</p>
</li>
<li>
<p>
In the web browser, open the Keycloak server home page, using the URL of the <code>keycloak</code> route. Click on the <code>Administration Console</code> link to open the Keycloak Administration Console. Log in with username <code>admin</code> and the password from the <code>keycloak-credentials</code> secret.
</p>
</li>
<li>
<p>
In the Keycloak administration console, select the <code>brokered-default</code> realm.
</p>
<div class="imageblock">
<div class="content">
<img src="images/enmasse-keycloak-brokered-default-realm.png" alt="images/enmasse-keycloak-brokered-default-realm.png" />
</div>
</div>
</li>
<li>
<p>
Navigate to the <code>Groups</code> tab, and click <code>New</code> to create a new group. Create the following groups&#8212;leave all settings as is:
</p>
<div class="ulist"><ul>
<li>
<p>
<code>send_*</code>
</p>
</li>
<li>
<p>
<code>recv_*</code>
</p>
</li>
<li>
<p>
<code>manage</code>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Navigate to the <code>Users</code> tab, and click <code>Add user</code> to create a new user.
</p>
<div class="ulist"><ul>
<li>
<p>
Use <code>coolstore</code> as username. Click <code>Save</code> to save the user.
</p>
<div class="imageblock">
<div class="content">
<img src="images/enmasse-keycloak-user-coolstore.png" alt="images/enmasse-keycloak-user-coolstore.png" />
</div>
</div>
</li>
</ul></div>
</li>
<li>
<p>
Navigate to the <code>Credentials</code> tab of the user page, and set the password to <code>password</code>. Be sure to uncheck the <code>Temporary</code> switch. Click on <code>Reset Password</code> to save the password.
</p>
<div class="imageblock">
<div class="content">
<img src="images/enmasse-keycloak-user-password.png" alt="images/enmasse-keycloak-user-password.png" />
</div>
</div>
</li>
<li>
<p>
Navigate to the <code>Groups</code> tab of the user page, and add the <code>send_*</code>, <code>recv_*</code> and <code>manage</code> groups to the <code>Group Membership</code> list.
</p>
<div class="imageblock">
<div class="content">
<img src="images/enmasse-keycloak-user-groups.png" alt="images/enmasse-keycloak-user-groups.png" />
</div>
</div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_create_addresses">1.4. Create Addresses</h3>
<div class="paragraph"><p>Addresses (queues or topics) in the EnMasse address space can be created through the address-controller REST API, or through the EnMasse console.</p></div>
<div class="paragraph"><p>For this lab, you create a topic named <code>coolstore-checkout-topic</code>.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a JSON payload for the EnMasse address controller REST API:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ read -r -d '' _DATA_JSON &lt;&lt; EOM
{
  "apiVersion": "enmasse.io/v1",
  "kind": "AddressList",
  "items": [
    {
      "metadata": {
        "name": "coolstore-checkout-topic",
        "addressSpace": "brokered-default"
      },
      "spec": {
        "address": "coolstore-checkout-topic",
        "type": "topic",
        "plan": "brokered-topic"
      }
    }
  ]
}
EOM</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The brokered address space on EnMasse supports queues and topics.
</p>
</li>
<li>
<p>
Both address spaces and addresses can be restricted by a plan, which enforces a limit on resource usage across multiple dimensions. At the moment, only a predefined, standard (unrestricted) plan is available for queues and topics in the brokered address space.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Create the address
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ export TOKEN=`oc whoami -t`
$ curl -X POST -d "$_DATA_JSON" -H "content-type: application/json" \
    -H "Authorization: Bearer $TOKEN" -k \
    https://$(oc get route restapi -o jsonpath='{.spec.host}' -n $ENMASSE_PRJ)/apis/enmasse.io/v1/addresses/brokered-default</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre><code>{"apiVersion":"enmasse.io/v1","kind":"AddressList","items":[{"metadata":{"name":"coolstore-checkout-topic","addressSpace":"brokered-default","uuid":"b61ea034-84c1-3f74-bcc0-af0006197930"},"spec":{"type":"topic","plan":"standard","address":"coolstore-checkout-topic"},"status":{"isReady":false}}]}</code></pre>
</div></div>
</li>
<li>
<p>
Using the EnMasse web console, verify that the address was created successfully.
</p>
<div class="ulist"><ul>
<li>
<p>
In a web browser, navigate to the EnMasse web console. Use the URL of the <code>console</code> route.
</p>
</li>
<li>
<p>
Log in with username <code>coolstore</code> and password <code>password</code>.
</p>
</li>
<li>
<p>
Navigate to the <code>Addresses</code> tab.
</p>
</li>
<li>
<p>
Expect to see the <code>coolstore-checkout-topic</code> on the addresses page.
</p>
<div class="imageblock">
<div class="content">
<img src="images/enmasse-console-addresses.png" alt="images/enmasse-console-addresses.png" />
</div>
</div>
</li>
</ul></div>
</li>
<li>
<p>
As an alternative, addresses can also be created in the EnMasse web console.
</p>
<div class="ulist"><ul>
<li>
<p>
In a web browser, navigate to the EnMasse web console. Use the URL of the <code>console</code> route.
</p>
</li>
<li>
<p>
Log in with username <code>coolstore</code> and password <code>password</code>.
</p>
</li>
<li>
<p>
Navigate to the <code>Addresses</code> tab.
</p>
</li>
<li>
<p>
Click on the <code>Create</code> button.
</p>
</li>
<li>
<p>
Follow the wizard to create an address.
</p>
</li>
</ul></div>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_messaging_to_cart_service_spring_boot_application">2. Add Messaging to Cart Service Spring Boot Application</h2>
<div class="sectionbody">
<div class="paragraph"><p>The EnMasse broker in the brokered address space exposes different ports AMQP and AMQPS. Openwire and Core protocol are exposed over the AMQP port.</p></div>
<div class="ulist"><ul>
<li>
<p>
AMQP: 5672
</p>
</li>
<li>
<p>
AMQPS: 5671
</p>
</li>
</ul></div>
<div class="paragraph"><p>This can be verified by reviewing the <code>messaging</code> service in the EnMasse namespace:</p></div>
<div class="imageblock">
<div class="content">
<img src="images/enmasse-brokered-messaging-service.png" alt="images/enmasse-brokered-messaging-service.png" />
</div>
</div>
<div class="paragraph"><p>The <code>messaging</code> route exposes the <code>messaging</code> service, allowing clients external to the OpenShift cluster to send and receive messages to and from the broker. This external communication uses the AMQPS protocol with TLS SNI.</p></div>
<div class="paragraph"><p>Messaging clients inside the cluster can use all the protocols supported by the broker. In this lab, you will use the AMQPS protocol.</p></div>
<div class="paragraph"><p>The <em>Apache Qpid JMS</em> library is a AMQP 1.0 JMS 2.0 client. It allows to communicate with an AMQP broker using the familiar Java JMS API.</p></div>
<div class="sect2">
<h3 id="_cart_service_spring_boot_application">2.1. Cart Service Spring Boot Application</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the POM file of the cart service project, add the <code>org.amqphub.spring:amqp-10-jms-spring-boot-starter:0.4.0</code> dependency.
</p>
<div class="ulist"><ul>
<li>
<p>
This artifact is a community-maintained Spring Boot starter module for Apache Qpid JMS. It declares transitive dependencies to the Apache Qpid JMS library (version 0.26) and the Spring JMS module.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Configure the cart service application to use Qpid JMS.
</p>
<div class="ulist"><ul>
<li>
<p>
In the <code>CartServiceConfiguration</code> class, add the following fields:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Autowired
    private AMQP10JMSProperties properties;

    @Value("${amqpjms.session-cache-size}")
    private int jmsSessionCacheSize;</code></pre>
</div></div>
</li>
<li>
<p>
In the <code>CartServiceConfiguration</code> class, add the following method:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Bean
    public ConnectionFactory connectionFactory() {
        JmsConnectionFactory jcf = new AMQP10JMSConnectionFactoryFactory(properties)
                .createConnectionFactory(JmsConnectionFactory.class);
        CachingConnectionFactory connectionFactory = new CachingConnectionFactory(jcf);
        connectionFactory.setSessionCacheSize(jmsSessionCacheSize);
        return connectionFactory;
    }</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The Spring Boot auto-configuration for JMS creates a JMS ConnectionFactory which does not cache the JMS connection and settings. A new connection is created every time a message is sent, which is highly inefficient. JMS connections and sessions are meant to be reused. The <code>connectionFactory</code> method overrides the default auto-configuration and uses a <code>CachingConnectionFactory</code> instead, with a parametrizable session cache size.
</p>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>CartServiceConfiguration</code> class, add the following method:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Bean
    public MessageConverter jacksonJmsMessageConverter() {
      MappingJackson2MessageConverter converter = new MappingJackson2MessageConverter();
      converter.setTargetType(MessageType.TEXT);
      converter.setTypeIdPropertyName("_type");
      return converter;
    }</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
This bean is registered with the Spring <code>JmsTemplate</code> and provides automatic conversion of a POJO to a JSON payload for a JMS Text Message and vice-versa.
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>com.redhat.coolstore.cart.service</code> package, create an interface <code>ShoppingCartCheckoutService</code> with a method <code>checkout</code>:
</p>
<div class="listingblock">
<div class="content">
<pre><code>public interface ShoppingCartCheckoutService {

    void checkout(ShoppingCart shoppingCart);

}</code></pre>
</div></div>
</li>
<li>
<p>
In the same package, create an implementation class for the <code>ShoppingCartCheckoutService</code> interface:
</p>
<div class="listingblock">
<div class="content">
<pre><code>@Component
public class ShoppingCartCheckoutServiceImpl implements ShoppingCartCheckoutService {

    @Autowired
    private JmsTemplate jmsTemplate;

    @Value("${cart.checkout.destination}")
    private String checkoutDestination;

    @Override
    public void checkout(ShoppingCart shoppingCart) {
        jmsTemplate.convertAndSend(checkoutDestination, shoppingCart);
    }
}</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
<code>JmsTemplate</code> is a Spring helper class that simplifies (synchronous) JMS access code. Spring Boot JMS auto-configuration automatically creates a <code>JmsTemplate</code> instance that can be injected in other Spring components.
</p>
</li>
<li>
<p>
The <code>JmsTemplate</code> instance is initialized with the JMS ConnectionFactory and message converter created earlier in the lab. As such it leverages caching of JMS Connections and Sessions, as well as automatic conversion between POJO&#8217;s and their JSON representation.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Refactor the <code>ShoppingCartServiceImpl</code> class to make use of the <code>ShoppingCartCheckoutService</code>.
</p>
<div class="ulist"><ul>
<li>
<p>
Inject an instance of <code>ShoppingCartCheckoutService</code>:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Autowired
    private ShoppingCartCheckoutService checkoutService;</code></pre>
</div></div>
</li>
<li>
<p>
Refactor the <code>checkoutShoppingCart</code> method to use the injected service:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Override
    public ShoppingCart checkoutShoppingCart(String cartId) {
        ShoppingCart sc = cartDB.get(cartId);
        if (sc != null) {
            checkoutService.checkout(sc);
            sc.clear();
        } else {
            sc = new ShoppingCart();
            sc.setId(cartId);
        }
        cartDB.put(sc.getId(), sc);
        return sc;
    }</code></pre>
</div></div>
</li>
<li>
<p>
Add a convenience method <code>clear</code> to the <code>ShoppingCart</code> class in the <code>com.redhat.coolstore.cart.model</code> package.
</p>
<div class="listingblock">
<div class="content">
<pre><code>    public void clear() {
        this.cartItemTotal = 0.0;
        this.cartTotal = 0.0;
        this.shippingTotal = 0.0;
        this.shoppingCartItemList.clear();
    }</code></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Refactor the test suite.
</p>
<div class="ulist"><ul>
<li>
<p>
In the <code>ShoppingCartServiceImplTest</code> test class, inject a mocked instance of <code>ShoppingCartCheckoutService</code>, and fix the <code>testCheckoutCart</code> test.
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Mock
    private ShoppingCartCheckoutService shoppingCartCheckoutService;

    [...]

    @Before
    public void setup() {
        initMocks();
        shoppingCartService = new ShoppingCartServiceImpl();
        [...]
        ReflectionTestUtils.setField(shoppingCartService, null, shoppingCartCheckoutService, ShoppingCartCheckoutService.class);
    }

    [...]

    @Test
    public void testCheckoutCart() {
        ShoppingCart initSc = shoppingCartService.addToCart("123456", "p1", 3);

        ShoppingCart sc = shoppingCartService.checkoutShoppingCart("123456");

        assertThat(sc, notNullValue());
        assertThat(sc.getId(), equalTo("123456"));
        assertThat(sc.getCartItemTotal(), equalTo(0.0));
        assertThat(sc.getShippingTotal(), equalTo(0.0));
        assertThat(sc.getCartTotal(), equalTo(0.0));
        assertThat(sc.getShoppingCartItemList().size(), equalTo(0));

        verify(shoppingCartCheckoutService, times(1)).checkout(any(ShoppingCart.class));

        //make sure we also updated the cart store
        sc = shoppingCartService.getShoppingCart("123456");
        assertThat(sc, notNullValue());
        assertThat(sc.getId(), equalTo("123456"));
        assertThat(sc.getCartItemTotal(), equalTo(0.0));
        assertThat(sc.getShippingTotal(), equalTo(0.0));
        assertThat(sc.getCartTotal(), equalTo(0.0));
        assertThat(sc.getShoppingCartItemList().size(), equalTo(0));
    }</code></pre>
</div></div>
</li>
<li>
<p>
In the <code>com.redhat.coolstore.cart.service</code> package in the <code>test/java</code> source folder, create a class <code>NoOpShoppingCartCheckoutService</code>:
</p>
<div class="listingblock">
<div class="content">
<pre><code>@Component
@Primary
@Profile("test")
public class NoOpShoppingCartCheckoutService implements ShoppingCartCheckoutService {

    @Override
    public void checkout(ShoppingCart shoppingCart) {

    }
}</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
An instance of this mock service class will be injected instead of the real implementation class in the <code>CartEndpointTest</code> test case, mocking out the interaction with the JMS layer.
</p>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>application-test.properties</code> file in the <code>src/test/resources</code> directory, add the following properties:
</p>
<div class="listingblock">
<div class="content">
<pre><code>cart.checkout.destination=test-topic
amqpjms.session-cache-size=1</code></pre>
</div></div>
</li>
<li>
<p>
In the <code>application.properties</code> file inthe <code>src/main/resources</code> directory, add the following property:
</p>
<div class="listingblock">
<div class="content">
<pre><code>management.health.defaults.enabled=false
management.health.jms.enabled=false</code></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Run the tests. Expect all tests to succeed.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_deploy_to_openshift">2.2. Deploy to OpenShift</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Add the following section to the <code>cart-service</code> ConfigMap in the cart service project:
</p>
<div class="listingblock">
<div class="content">
<pre><code>  amqp.host: messaging.userXYZ-enmasse.svc.cluster.local
  amqp.port: '5671'
  amqp.query: transport.trustAll=true&amp;transport.verifyHost=false
  amqphub.amqp10jms.password: password
  amqphub.amqp10jms.remote-url: 'amqps://${amqp.host}:${amqp.port}?${amqp.query}'
  amqphub.amqp10jms.username: coolstore
  amqpjms.session-cache-size: '10'
  cart.checkout.destination: coolstore-checkout-topic
  catalog.service.url: 'http://catalog-service-user51-coolstore.apps.2ba9.openshift.opentlc.com'
  spring.jms.pub-sub-domain: 'True'</code></pre>
</div></div>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Be sure to change the value of the <strong>amqp.host</strong>. Use your student number in place of userXYZ.</td>
</tr></table>
</div>
<div class="ulist"><ul>
<li>
<p>
<code>amqphub.amqp10jms.remote-url</code> represents the url to the AMQP messaging broker. The host name is the OpenShift internal DNS name of the <code>messaging</code> service in the EnMasse project. The port is the <em>amqps</em> port. To connect to the broker from outside of OpenShift, the host name would be the hostname corresponding to the <code>messaging</code> route and port 443.
</p>
</li>
<li>
<p>
The protocol used is amqps, or secure amqp, using SSL. The <code>transport.trustAll=true&amp;transport.verifyHost=false</code> configures the JMS client not to check the server certificate.
</p>
</li>
<li>
<p>
The username and password correspond to the user created earlier in Keycloak.
</p>
</li>
<li>
<p>
<code>spring.jms.pub-sub-domain</code> tells the Spring <code>JmsTemplate</code> that the destination is a topic. Under the hood <code>java.jms.Session.createTopic()</code> is called rather than <code>java.jms.Session.createQueue()</code>.
</p>
</li>
<li>
<p>
<code>amqpjms.session-cache-size</code> is the size of the JMS Session cache.
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Deploy the cart service with the Fabric8 Maven plug-in.
</p>
</li>
<li>
<p>
Test the cart service using curl. When a cart is checked out, a message is sent to the <code>coolstore-checkout-topic</code> topic.
</p>
</li>
<li>
<p>
Verify that checkout messages are sent to the topic using the EnMasse web console. The <code>Connections</code> tab shows 1 connection coming from the cart service application, and shows how many messages have been delivered to the topic. Note that the topic does not have consumers at the moment, and messages are discarded.
</p>
<div class="imageblock">
<div class="content">
<img src="images/enmasse-console-connections-sender.png" alt="images/enmasse-console-connections-sender.png" />
</div>
</div>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_add_truststore">2.3. Add Truststore</h3>
<div class="paragraph"><p>The cart service connects to the Enmasse AMQP broker using the secure <code>amqps</code> protocol. However, at the client side, the server certificate is not verified. To do so, the server certificate&#8212;a self-signed certificate generated when EnMasse is deployed must be added to the client trust store.</p></div>
<div class="paragraph"><p>Note: in a production system, the self-signed certificate should be replaced with a certificate signed by a trusted Certificate Authority.</p></div>
<div class="paragraph"><p>The certificate is stored as a secret in the Enmasse project. The name of the secret is <code>external-certs-messaging</code>, and the certificate is stored in base64 format under the <code>tls.crt</code> key.</p></div>
<div class="paragraph"><p>In this section of the lab you extract the certificate from the secret, and add it to a keystore which will be used by the cart service application.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Extract the certificate from the <code>external-certs-messaging</code> in the EnMasse project. Store the resulting certificate in a temporary file. If you have the <code>jq</code> tool installed, you can use the following command:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ oc get secret external-certs-messaging -n enmasse -o json | jq '.data ."tls.crt"' | sed 's/"//g' | base64 -d &gt; /tmp/messaging.crt</code></pre>
</div></div>
<div class="paragraph"><p>Alternatively, you can also use sed:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ oc get secret external-certs-messaging -n enmasse -o json | sed -e '1h;2,$H;$!d;g' -e 's/.*"tls.crt": "//g' | sed -e '1h;2,$H;$!d;g' -e 's/".*//g' | base64 -d &gt; /tmp/messaging.crt</code></pre>
</div></div>
</li>
<li>
<p>
Verify that the certificate has been correctly extracted:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ cat /tmp/messaging.crt</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Sample output:</div>
<div class="content">
<pre><code>-----BEGIN CERTIFICATE-----
MIIDWTCCAkGgAwIBAgIJAM+er07zw3M5MA0GCSqGSIb3DQEBCwUAMEMxEzARBgNV
BAoMCmlvLmVubWFzc2UxLDAqBgNVBAMMI21lc3NhZ2luZy5lbm1hc3NlLnN2Yy5j
bHVzdGVyLmxvY2FsMB4XDTE4MDIwMTE2MTAxNFoXDTQ4MDMxNTE2MTAxNFowQzET
MBEGA1UECgwKaW8uZW5tYXNzZTEsMCoGA1UEAwwjbWVzc2FnaW5nLmVubWFzc2Uu
c3ZjLmNsdXN0ZXIubG9jYWwwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIB
AQDHI/3FNre93r8CZHx73oJ7to8FymIFaLZXdJmvgw56JOaMsEJj8KOpE7AWjabo
vuOVizI949TgZHmSSfQqH2GDARbKhBJjEqJfAh9byggvHEayeSb5T/VN4/RuSxcF
axAF8EEwrss0MoNM8DAZjDUMmnyfMrRlzB29y/o4MQG8u0U4aGvgWwY7ebETx1UR
0aw2pXbHLnnJ2rBIUNhF7L3EaSqbQkVqJIulntBSdyJcylHfck/bj/2ZyOkmDjJc
Fwv0yH761L1zQKT6kZxzZZU2oDbcbKlVmE/7Sx9IZYCQybIJBIgKH4j61CmHkffD
icIzdjh6rNHiFGmRviHZfQTdAgMBAAGjUDBOMB0GA1UdDgQWBBQNjovOUU7HMth6
0iOLvDZd5LIGyzAfBgNVHSMEGDAWgBQNjovOUU7HMth60iOLvDZd5LIGyzAMBgNV
HRMEBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQA+l1L3Z2EKhL7+kDblVMkywMl/
4KWxNUAPw4xeC8nDD8QDMIPdrX5b5heTQrxSJBc6kkAfunHeyyKIEnIJ0+xsstT5
TOuBJFJiSrSYTTDdra7NsbO8Z52InkBL/rhIf6izp05YqtCc4jC8deIBF5VLe/Ya
BMFlr0pE/XMtOikJZN1JXQN5Fl3D1tiWDUof5SkoOtlhtli789v7VKaqIpYBv7QB
yEzw9cxCVuTYdj5lU1nYXC0toIelAacbHP+TA1lR+TfZE02aZq9TkYFW4cnAJ6Of
PM1jykCjkauoUNUYPs3hi/reiQyNSWk6FZssm8G/uLiYrsbsj6XVZhVGI5/O
-----END CERTIFICATE-----</code></pre>
</div></div>
</li>
<li>
<p>
To inspect the contents of the certificate:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ openssl x509 -in /tmp/messaging.crt -text -noout</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre><code>Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            cf:9e:af:4e:f3:c3:73:39
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: O = io.enmasse, CN = messaging.enmasse.svc.cluster.local
        Validity
            Not Before: Feb  1 16:10:14 2018 GMT
            Not After : Mar 15 16:10:14 2048 GMT
        Subject: O = io.enmasse, CN = messaging.enmasse.svc.cluster.local
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    [...]
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier:
                0D:8E:8B:CE:51:4E:C7:32:D8:7A:D2:23:8B:BC:36:5D:E4:B2:06:CB
            X509v3 Authority Key Identifier:
                keyid:0D:8E:8B:CE:51:4E:C7:32:D8:7A:D2:23:8B:BC:36:5D:E4:B2:06:CB
            X509v3 Basic Constraints:
                CA:TRUE
    Signature Algorithm: sha256WithRSAEncryption
         [...]</code></pre>
</div></div>
</li>
<li>
<p>
Using the <code>keytool</code> tool, create a JKS keystore and import the broker certificate.
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ keytool -importcert -trustcacerts -file /tmp/messaging.crt -keystore /tmp/enmasse.jks -storepass password -noprompt</code></pre>
</div></div>
</li>
<li>
<p>
Create a secret in the cart service OpenShift project with the truststore:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ export CART_PRJ=&lt;name of the OpenShift cart service project&gt;
$ oc create secret generic enmasse-truststore --from-file=/tmp/enmasse.jks -n $CART_PRJ</code></pre>
</div></div>
</li>
<li>
<p>
In the <code>cart-service</code> ConfigMap in the cart service project, change the value of the <code>amqp.query</code> to:
</p>
<div class="listingblock">
<div class="content">
<pre><code>amqp.query=transport.trustAll=false&amp;transport.verifyHost=true</code></pre>
</div></div>
</li>
<li>
<p>
To configure the cart service application to use the truststore, add the following section to the <code>deployment.yml</code> file in the <code>src/main/fabric8</code> folder of the cart service source code:
</p>
<div class="listingblock">
<div class="content">
<pre><code>          volumeMounts:
            - name: truststore
              mountPath: /app/truststore
          env:
            - name: JAVA_OPTIONS
              value: "-Djavax.net.ssl.trustStore=/app/truststore/enmasse.jks -Djavax.net.ssl.trustStorePassword=password -Djavax.net.ssl.trustStoreType=JKS"
      volumes:
        - secret:
            secretName: enmasse-truststore
          name: truststore</code></pre>
</div></div>
<div class="paragraph"><p>Expect the complete <code>deployment.yml</code> to look like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>spec:
  template:
    spec:
      containers:
        - livenessProbe:
            failureThreshold: 2
            httpGet:
              path: "/health"
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: "/health"
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 20
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          resources:
            limits:
              cpu: 1
              memory: 1Gi
            requests:
              cpu: 200m
              memory: 200Mi
          volumeMounts:
            - name: truststore
              mountPath: /app/truststore
          env:
            - name: JAVA_OPTIONS
              value: "-Djavax.net.ssl.trustStore=/app/truststore/enmasse.jks -Djavax.net.ssl.trustStorePassword=password -Djavax.net.ssl.trustStoreType=JKS"
      volumes:
        - secret:
            secretName: enmasse-truststore
          name: truststore</code></pre>
</div></div>
</li>
<li>
<p>
Redeploy the cart service  application to OpenShift using the Fabric8 Maven plug-in, and test the application.
</p>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_message_consumer_application">3. Message Consumer Application</h2>
<div class="sectionbody">
<div class="paragraph"><p>The lab source code contains a skeleton Spring Boot application <code>checkout-service-sb</code>. In this lab you enhance the functionality of this application to consume messages from the AMQP topic created earlier.</p></div>
<div class="sect2">
<h3 id="_import_into_ide">3.1. Import into IDE</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Import the <code>checkout-service-sb</code> application project in the lab home folder into your IDE.
</p>
</li>
<li>
<p>
Review the source code of the application. At the moment it consists of a main class and a REST health check endpoint.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_consume_jms_messages_from_amqp_topic">3.2. Consume JMS messages from AMQP topic</h3>
<div class="paragraph"><p>The Spring JMS functionality makes it relatively straight-forward to consume JMS messages from queues or topics. Spring JMS has support for message driven POJOs, which allow to create message consumers by simply annotating a method in a Spring managed Bean.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the POM file of the checkout service project, add the <code>org.amqphub.spring:amqp-10-jms-spring-boot-starter:0.4.0</code> dependency.
</p>
</li>
<li>
<p>
Add the <code>@EnableJms</code> annotation to the <code>ServiceCheckoutApplication</code> main class.
</p>
<div class="listingblock">
<div class="content">
<pre><code>@SpringBootApplication
@EnableJms
public class CheckoutServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(CheckoutServiceApplication.class, args);
    }

}</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The <code>@EnableJms</code> annotation enables JMS listener annotated endpoints that are created automatically.
</p>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>ApplicationConfiguration</code> class in the <code>com.redhat.coolstore.checkout</code> package, add a boolean field <code>subscriptionShared</code>, with a setter.
</p>
<div class="listingblock">
<div class="content">
<pre><code>private boolean subscriptionShared;

public void setSubscriptionShared(boolean subscriptionShared) {
    this.subscriptionShared = subscriptionShared;
}</code></pre>
</div></div>
</li>
<li>
<p>
Annotate the class with the <code>@ConfigurationProperties("spring.jms")</code> annotation
</p>
</li>
<li>
<p>
Add the following method, annotated with the <code>@Bean</code> method to the class:
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Bean
    public DefaultJmsListenerContainerFactory jmsListenerContainerFactory(
            DefaultJmsListenerContainerFactoryConfigurer configurer,
            ConnectionFactory connectionFactory) {
        DefaultJmsListenerContainerFactory factory = new DefaultJmsListenerContainerFactory();
        factory.setSubscriptionShared(subscriptionShared);
        configurer.configure(factory, connectionFactory);
        return factory;
    }</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
By default, Spring Boot auto-configuration will automatically configure the factory class for the JMS listener POJOs.
</p>
</li>
<li>
<p>
By default, auto-configured JMS listener POJOs do not use shared topic subscriptions. This means that if there is a pool of listeners (which allows the application to scale), each listener instance will consume every message from the topic. By specifying a shared topic subscription, only one listener instance will consume a message.
</p>
</li>
<li>
<p>
To configure the Spring JMS listener factory class to use shared subscriptions, you need to override the default factory producer method.
</p>
</li>
<li>
<p>
The combination of the <code>@ConfigurationProperties</code> annotation and the <code>subscriptionShared</code> field allows you to define a <code>spring.jms.subscription-shared</code> configuration property to configure the JMS listener factory to use shared subscriptions.
</p>
</li>
</ul></div>
</li>
<li>
<p>
In the <code>com.redhat.coolstore.checkout.service</code> package, create a class <code>CheckoutMessageConsumer</code>. Annotate the class with the Spring <code>@Component</code> annotation.
</p>
</li>
<li>
<p>
In the class, create a method to consume messages. For the moment, it is sufficient to log the contents of the message.
</p>
<div class="listingblock">
<div class="content">
<pre><code>    private static Logger log = LoggerFactory.getLogger(CheckoutMessageConsumer.class);

    public void processMessage(String message) {
        log.info("Received checkout message: " + message);
    }</code></pre>
</div></div>
</li>
<li>
<p>
Annotate the method with the <code>@JmsListener</code> method
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @JmsListener(destination = "${consumer.destination}", subscription= "${consumer.subscription}")
    public void processMessage(String message) {
        log.info("Received checkout message: " + message);
    }</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
The <code>@JmsListener</code> annotation configures the <code>MessageConsumer</code>  as a message listener POJO. The <code>processMessage</code> is called whenever a message is received from the destination.
</p>
</li>
<li>
<p>
Spring JMS converts the message payload to the listener method parameter type. In the case of JMS text messages, conversion to String does not require any specific configuration.
</p>
</li>
<li>
<p>
The <code>subscription</code> attribute of the <code>@JmsListener</code> annotation defines the name of the shared topic subscription used by the listener instances. <code>${}</code> notation can be used to inject the values of external properties.
</p>
</li>
</ul></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_deploy_to_openshift_2">3.3. Deploy to Openshift</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a file called <code>application.properties</code> with the following contents:
</p>
<div class="listingblock">
<div class="content">
<pre><code>amqp.host=messaging.enmasse.svc.cluster.local
amqp.port=5671
amqp.query=transport.trustAll=true&amp;transport.verifyHost=false
amqphub.amqp10jms.remote-url=amqps://${amqp.host}:${amqp.port}?${amqp.query}
amqphub.amqp10jms.username=coolstore
amqphub.amqp10jms.password=password

spring.jms.listener.concurrency=10
spring.jms.listener.max-concurrency=10
spring.jms.pub-sub-domain=true
spring.jms.subscription-shared=true

consumer.destination=coolstore-checkout-topic
consumer.subscription=coolstore-checkout</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
<code>spring.jms.listener.concurrency</code> and <code>spring.jms.listener.max-concurrency</code> define the number of listener instances to create.
</p>
</li>
<li>
<p>
<code>spring.jms.subscription-shared</code> configures whether to use shared subscriptions or not. Note that this is not a default Spring JMS configuration property, but support for it was added in the <code>ApplicationConfiguration</code> class.
</p>
</li>
<li>
<p>
The values of <code>consumer.destination</code> and <code>consumer.subcription</code> are injected in the <code>@JmsListener</code> annotation attributes in the <code>MessageConsumer</code> class.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Using the <code>oc</code> command line utility, create a ConfigMap <code>checkout-service</code> in the OpenShift cart service project.
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ export CART_PRJ=&lt;name of the OpenShift cart service project&gt;
$ oc create configmap checkout-service --from-file=application.properties -n $CART_PRJ</code></pre>
</div></div>
</li>
<li>
<p>
Deploy the checkpout application with the Fabric8 Maven plug-in.
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ export CART_PRJ=&lt;name of the OpenShift cart service project&gt;
$ mvn clean fabric8:deploy -Popenshift -Dfabric8.namespace=$CART_PRJ</code></pre>
</div></div>
</li>
<li>
<p>
Test the cart service. Using <code>curl</code>, add some items to a shopping cart, and checkout the cart. Upon checkout of a shopping cart, check the logs of the checkout service application. Expect to see output similar to:
</p>
<div class="listingblock">
<div class="content">
<pre><code>2018-02-05 17:11:01.509  INFO 13 --- [enerContainer-3] c.r.c.c.service.CheckoutMessageConsumer  : Received checkout message: {"id":"mycart3","cartItemTotal":57.5,"shippingTotal":6.99,"cartTotal":64.49,"shoppingCartItemList":[{"price":28.75,"quantity":2,"product":{"itemId":"165614","name":"Ogio Caliber Polo","desc":"Moisture-wicking 100% polyester. Rib-knit collar and cuffs; Ogio jacquard tape inside neck; bar-tacked three-button placket with Ogio dyed-to-match buttons; side vents; tagless; Ogio badge on left sleeve. Import. Embroidery. Black.","price":28.75}}]}</code></pre>
</div></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_durable_subscription">3.4. Durable subscription</h3>
<div class="paragraph"><p>If the checkout service is down, messages sent to the checkout topic will be lost. To avoid this scenario, the checkout service can use a durable subscription. A durable subscription preserves messages published on a topic while the subscriber is not active.</p></div>
<div class="paragraph"><p>In this lab you refactor the checkout service to use a durable subscription.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the <code>ApplicationConfiguration</code> class in the <code>com.redhat.coolstore.checkout</code> package, add a boolean field <code>subscriptionShared</code>, with a setter.
</p>
<div class="listingblock">
<div class="content">
<pre><code>private boolean subscriptionDurable;

public void setSubscriptionDurable(boolean subscriptionDurable) {
    this.subscriptionDurable = subscriptionDurable;
}</code></pre>
</div></div>
</li>
<li>
<p>
In the <code>jmsListenerContainerFactory</code> method of the ApplicationConfiguration` class, set the <code>subscriptionDurable</code> property of the <code>DefaultJmsListenerContainerFactory</code>.
</p>
<div class="listingblock">
<div class="content">
<pre><code>    @Bean
    public DefaultJmsListenerContainerFactory jmsListenerContainerFactory(
            DefaultJmsListenerContainerFactoryConfigurer configurer,
            ConnectionFactory connectionFactory) {
        DefaultJmsListenerContainerFactory factory = new DefaultJmsListenerContainerFactory();
        factory.setSubscriptionShared(subscriptionShared);
        factory.setSubscriptionDurable(subscriptionDurable);
        configurer.configure(factory, connectionFactory);
        return factory;
    }</code></pre>
</div></div>
</li>
<li>
<p>
Add the following property to the <code>checkout-service</code> ConfigMap in the cart service project:
</p>
<div class="listingblock">
<div class="content">
<pre><code>spring.jms.subscription-durable=true</code></pre>
</div></div>
</li>
<li>
<p>
Redeploy the checkout application to OpenShift with the Fabric8 Maven plug-in.
</p>
</li>
<li>
<p>
Test the cart service. Using <code>curl</code>, add some items to a shopping cart, and checkout the cart. Upon checkout of a shopping cart, check the logs of the checkout service application.<br />
Scale down the checkout service application to 0 pod instances. Repeat the cart service test. Scale up the checkout service application to 1 pod instance. Notice that the checkout service application consumes the missed checkout topic message when connecting to the topic.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Congratulations, you&#8217;ve reached the end of the lab.</p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2018-10-26 04:51:10 EDT
</div>
</div>
</body>
</html>
